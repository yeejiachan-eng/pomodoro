<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LifeRPG - v5.8 (Categorized Tasks)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* --- ÂÖ®Â±ÄË®≠ÂÆö --- */
        * { box-sizing: border-box; }

        html, body {
            margin: 0;
            padding: 0;
            background-color: #2d3748; 
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Noto Sans TC', sans-serif;
            color: #1a202c;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
        }

        #root {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            max-width: 100vw;
        }

        /* ÂÉèÁ¥†Â≠óÈ´î */
        .font-pixel { font-family: 'VT323', monospace; }

        /* Ëº∏ÂÖ•Ê°Ü */
        input, select, textarea {
            font-size: 16px !important;
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            color: #2d3748;
            border-radius: 4px;
        }
        input:focus, select:focus {
            outline: 2px solid #63b3ed;
            border-color: #63b3ed;
        }

        /* --- RO È¢®Ê†ºÂÖÉ‰ª∂ --- */
        .ro-window {
            background: linear-gradient(to bottom, #f0f4f8, #e2e8f0);
            border: 1px solid #a0aec0;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            position: relative;
            width: 100%;
            max-width: 100%;
        }

        .ro-title-bar {
            background: linear-gradient(to bottom, #bfdcf5, #8db2e3);
            border-bottom: 1px solid #7a9bc9;
            color: #1a365d;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            border-radius: 5px 5px 0 0;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .ro-bar-container {
            background: #2d3748;
            border-radius: 9999px;
            padding: 2px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
            border: 1px solid #4a5568;
        }
        
        .ro-bar-fill {
            background: linear-gradient(to bottom, #8ec5fc 0%, #4a90e2 50%, #2b6cb0 51%, #2c5282 100%);
            border-radius: 9999px;
            position: relative;
            overflow: hidden;
        }
        
        .ro-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.6), rgba(255,255,255,0.1));
            border-radius: 9999px 9999px 0 0;
        }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }

        .ro-btn-base {
            border: 1px solid transparent;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: all 0.1s;
        }
        .ro-btn-base:active { transform: translateY(1px); box-shadow: none; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* ËΩâËÅ∑ÂãïÁï´ */
        @keyframes job-change-shine {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .animate-job-change { animation: job-change-shine 1.5s infinite; }

        /* Êó•ÊõÜÊ®£Âºè */
        .calendar-day { text-align: center; padding: 6px 0; font-size: 0.8rem; border-radius: 4px; }
        .calendar-day.today { border: 2px solid #63b3ed; font-weight: bold; }
        .calendar-day.selected { background-color: #3182ce; color: white; }
        .calendar-day.has-data { position: relative; }
        .calendar-day.has-data::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background-color: #48bb78; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import * as LucideReact from "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0";

        const { 
            Trophy, Zap, CheckCircle2, Plus, Trash2, Dumbbell, BookOpen, Home, 
            TrendingUp, Lock, Unlock, Star, RefreshCw, X, Briefcase, Heart, 
            Calendar, Clock, Repeat, Download, Filter, HardHat, Info, Settings, Upload, Save, Sword, User, Crown, Sparkles, Gift, Coins, ShoppingBag, Battery,
            ChevronLeft, ChevronRight, RotateCcw, Volume2, VolumeX, ArrowRight, Star: StarIcon, Coffee, ShoppingCart, Moon, AlertTriangle
        } = LucideReact;

        // --- Audio System ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type, duration, delay = 0, vol = 0.1) => {
            if (!window.soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + delay + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration);
        };
        const sfx = {
            click: () => playTone(800, 'triangle', 0.05, 0, 0.05),
            confirm: () => { playTone(600, 'square', 0.1, 0, 0.05); playTone(1200, 'square', 0.1, 0.05, 0.05); },
            step: () => { playTone(900, 'sine', 0.05, 0, 0.05); playTone(1500, 'sine', 0.05, 0.05, 0.05); },
            cancel: () => { playTone(300, 'sawtooth', 0.1, 0, 0.05); playTone(150, 'sawtooth', 0.2, 0.1, 0.05); },
            success: () => { playTone(1200, 'sine', 0.1, 0, 0.1); playTone(2400, 'sine', 0.4, 0.05, 0.1); },
            levelup: () => { const now = 0; playTone(523.25, 'square', 0.2, now, 0.1); playTone(659.25, 'square', 0.2, now + 0.1, 0.1); playTone(783.99, 'square', 0.2, now + 0.2, 0.1); playTone(1046.50, 'square', 0.6, now + 0.3, 0.1); }
        };

        // --- UI Components ---
        const Card = ({ children, className = "", title }) => (
            <div className={`ro-window flex flex-col ${className}`}>
                {title && <div className="ro-title-bar flex items-center gap-2">{title}</div>}
                <div className="p-3 w-full">{children}</div>
            </div>
        );

        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const variants = {
                primary: "bg-blue-100 hover:bg-blue-200 text-blue-900 border-blue-300",
                secondary: "bg-gray-100 hover:bg-gray-200 text-gray-800 border-gray-300",
                danger: "bg-red-50 hover:bg-red-100 text-red-800 border-red-200",
                outline: "bg-transparent border-slate-400 text-slate-600 hover:bg-slate-100",
                gold: "bg-yellow-100 hover:bg-yellow-200 text-yellow-900 border-yellow-400",
                green: "bg-emerald-100 hover:bg-emerald-200 text-emerald-900 border-emerald-300"
            };
            const handleClick = (e) => { if (!disabled) sfx.click(); if (onClick) onClick(e); };
            return <button onClick={handleClick} disabled={disabled} className={`ro-btn-base px-3 py-2 rounded text-sm font-bold flex items-center justify-center gap-2 ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>{children}</button>;
        };

        const ProgressBar = ({ current, max, label, height = "h-4", type = "hp" }) => {
            const percentage = Math.min(100, Math.max(0, (current / max) * 100));
            let barColor = 'bg-gradient-to-b from-blue-400 via-blue-500 to-blue-700'; 
            if (type === 'hp') barColor = 'bg-gradient-to-b from-red-400 via-red-500 to-red-700';
            if (type === 'stamina') barColor = 'bg-gradient-to-b from-emerald-400 via-emerald-500 to-emerald-700';
            return (
                <div className="w-full select-none">
                    <div className="ro-bar-container w-full">
                        <div className={`${height} w-full relative`}>
                            <div className="absolute inset-0 w-full h-full bg-slate-800 rounded-full"></div>
                            <div className={`h-full ro-bar-fill transition-all duration-500 ease-out ${barColor}`} style={{ width: `${percentage}%` }} />
                            <div className="absolute inset-0 flex items-center justify-center z-10">
                                <span className="text-white font-pixel text-[12px] sm:text-[14px] drop-shadow-[0_1px_1px_rgba(0,0,0,1)] tracking-wide">{Math.floor(current)} / {max}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            const handleClose = () => { sfx.cancel(); onClose(); }
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm px-4">
                    <div className="ro-window w-full max-w-sm flex flex-col max-h-[85vh] shadow-2xl animate-slide-up">
                        <div className="ro-title-bar flex justify-between items-center shrink-0"><h3 className="flex items-center gap-2 text-sm"><Info size={14}/> {title}</h3><button onClick={handleClose} className="text-slate-600 hover:text-red-600 hover:bg-white/50 rounded p-0.5"><X size={18} /></button></div>
                        <div className="p-4 overflow-y-auto bg-[#f7fafc]">{children}</div>
                    </div>
                </div>
            );
        };

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const styles = { success: "bg-emerald-100 text-emerald-800 border-emerald-300", error: "bg-red-100 text-red-800 border-red-300", info: "bg-blue-100 text-blue-800 border-blue-300", gold: "bg-yellow-100 text-yellow-800 border-yellow-300 shadow-[0_0_10px_rgba(250,204,21,0.5)]" };
            return (
                <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[70] flex items-center justify-between gap-3 px-4 py-2 rounded-lg border shadow-lg w-[90%] max-w-sm ${styles[type] || styles.info}`}><span className="truncate text-sm font-bold">{message}</span><button onClick={onClose} className="opacity-60 hover:opacity-100"><X size={16} /></button></div>
            );
        };

        // --- App Logic ---
        function LifeRPG() {
            const [user, setUser] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('liferpg-user-v2');
                    if (saved) { const parsed = JSON.parse(saved); return { ...parsed, name: parsed.name || "Player", jobTitle: parsed.jobTitle || "Â∑•Á®ãÂ∏´", zeny: parsed.zeny || 0, stamina: parsed.stamina || { current: 100, max: 100 }, sound: parsed.sound !== undefined ? parsed.sound : true }; }
                } catch (e) { console.error("Load Error", e); }
                return { name: "Player", jobTitle: "Â∑•Á®ãÂ∏´", zeny: 0, base: { level: 1, xp: 0, maxXp: 100 }, job: { level: 1, xp: 0, maxXp: 100 }, stamina: { current: 100, max: 100 }, totalTasksCompleted: 0, sound: true };
            });

            window.soundEnabled = user.sound;

            function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7); }
            const calculateMaxXP = (level) => { let xp = 100; for (let i = 1; i < level; i++) xp = Math.floor(xp * 1.2); return xp; };

            const [appState, setAppState] = React.useState(() => { const saved = localStorage.getItem('liferpg-app-state'); return saved ? JSON.parse(saved) : { lastVisitDate: new Date().toDateString(), lastVisitWeek: getWeekNumber(new Date()) }; });
            const [tasks, setTasks] = React.useState(() => { const saved = localStorage.getItem('liferpg-tasks'); return saved ? JSON.parse(saved) : [ { id: 1, title: "ÈÅõÁãó", category: "fitness", xp: 30, money: 50, completed: false, repeat: 'daily' }, { id: 2, title: "ÂÅ•Ë∫´/ÈÅãÂãï", category: "fitness", xp: 50, money: 100, stamina: 34, completed: false, repeat: 'daily' }, { id: 3, title: "Ê¥óË°£Êúç", category: "chores", xp: 40, money: 60, completed: false, repeat: 'weekly' }, ]; });
            const [dailyCompletions, setDailyCompletions] = React.useState(() => { const saved = localStorage.getItem('liferpg-daily-completions'); return saved ? JSON.parse(saved) : {}; });
            const [rewards, setRewards] = React.useState(() => { const saved = localStorage.getItem('liferpg-rewards-v2'); return saved ? JSON.parse(saved) : [ { id: 1, title: "ÊîæÁ∏±È§ê", reqType: 'base', levelReq: 2, cost: 600, currency: 'zeny', category: 'food', unlocked: false }, { id: 2, title: "Ë≤∑Êñ∞ÈÅäÊà≤", reqType: 'job', levelReq: 5, cost: 3000, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 999, title: "ËÅñ‰∫∫Ê®°Âºè (ÈáãÊîæ)", reqType: 'base', levelReq: 1, cost: 100, currency: 'stamina', category: 'special', unlocked: true }, ]; });
            const [history, setHistory] = React.useState(() => { const saved = localStorage.getItem('liferpg-history'); return saved ? JSON.parse(saved) : []; });

            const [activeTab, setActiveTab] = React.useState('tasks');
            const [questFilter, setQuestFilter] = React.useState('all'); 
            const [levelUpData, setLevelUpData] = React.useState(null);
            const [jobChangeData, setJobChangeData] = React.useState(null); 
            const [notification, setNotification] = React.useState(null); 
            const [showSettings, setShowSettings] = React.useState(false);
            const [showCalendar, setShowCalendar] = React.useState(false); 

            const [newTask, setNewTask] = React.useState({ title: '', category: 'fitness', xp: 20, repeat: 'daily', frequency: 1 });
            const [newReward, setNewReward] = React.useState({ title: '', reqType: 'base', levelReq: 2, cost: 100, category: 'food' });
            const [newJobTitle, setNewJobTitle] = React.useState(""); 

            const getISODate = (d) => { const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
            const [viewDate, setViewDate] = React.useState(new Date()); 
            const viewDateStr = getISODate(viewDate);
            const todayStr = getISODate(new Date());
            const isToday = viewDateStr === todayStr;
            const todayDate = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

             const categories = {
                fitness: { type: 'base', bg: "bg-red-100 text-red-800", icon: <Dumbbell size={14} />, label: "ÂÅ•Â∫∑" },
                chores: { type: 'base', bg: "bg-blue-100 text-blue-800", icon: <Home size={14} />, label: "ÈõúÂãô" },
                knowledge: { type: 'job', bg: "bg-purple-100 text-purple-800", icon: <BookOpen size={14} />, label: "Áü•Ë≠ò" },
                finance: { type: 'job', bg: "bg-emerald-100 text-emerald-800", icon: <TrendingUp size={14} />, label: "ÁêÜË≤°" },
                general: { type: 'base', bg: "bg-gray-100 text-gray-800", icon: <Star size={14} />, label: "‰∏ÄËà¨" },
            };

            const rewardCategories = {
                food: { label: "üçî È£≤È£ü‰∫´Âèó", color: "text-orange-600 border-orange-200 bg-orange-50" },
                relax: { label: "üí§ ‰ºëÊÅØÊîæÈ¨Ü", color: "text-teal-600 border-teal-200 bg-teal-50" },
                shopping: { label: "üõçÔ∏è Ë≥ºÁâ©ÁäíË≥û", color: "text-pink-600 border-pink-200 bg-pink-50" },
                special: { label: "‚ú® ÁâπÊÆäÂäüËÉΩ", color: "text-purple-600 border-purple-200 bg-purple-50" }
            };

            const showNotification = (message, type = 'info') => { setNotification({ message, type }); setTimeout(() => setNotification(null), 3000); };

            // --- CLOCK & WORK MODE LOGIC ---
            const [currentTimeState, setCurrentTimeState] = React.useState(new Date());
            const [workMode, setWorkMode] = React.useState(null); 

            React.useEffect(() => { const timer = setInterval(() => setCurrentTimeState(new Date()), 1000); return () => clearInterval(timer); }, []);

            const getClockStats = () => {
                const now = currentTimeState;
                const currentHour = now.getHours();
                const currentMin = now.getMinutes();
                const currentTimeVal = currentHour + currentMin / 60;
                const isWorkingDay = workMode !== null ? workMode : !(now.getDay() === 0 || now.getDay() === 6);
                const BEDTIME = 23; const WORK_START = 8; const WORK_END = 17; 
                if (currentTimeVal >= BEDTIME || currentTimeVal < 5) return { hours: 0, mins: 0, status: 'sleep' };
                let rawFreeHours = BEDTIME - currentTimeVal;
                let status = 'free';
                let finalFreeHours = rawFreeHours;
                if (isWorkingDay) {
                    const overlapStart = Math.max(currentTimeVal, WORK_START);
                    const overlapEnd = Math.min(BEDTIME, WORK_END);
                    if (overlapStart < overlapEnd) {
                        finalFreeHours -= (overlapEnd - overlapStart);
                        if (currentTimeVal >= WORK_START && currentTimeVal < WORK_END) status = 'working';
                    }
                }
                finalFreeHours = Math.max(0, finalFreeHours);
                return { hours: Math.floor(finalFreeHours), mins: Math.floor((finalFreeHours - Math.floor(finalFreeHours)) * 60), status, isWorkingDay };
            };

            const clockStats = getClockStats();
            const timeString = currentTimeState.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const toggleWorkMode = () => { sfx.click(); setWorkMode(prev => { if (prev === null) return !clockStats.isWorkingDay; return !prev; }); };

            // --- Persistence ---
            React.useEffect(() => { localStorage.setItem('liferpg-user-v2', JSON.stringify(user)); window.soundEnabled = user.sound; }, [user]);
            React.useEffect(() => { localStorage.setItem('liferpg-tasks', JSON.stringify(tasks)); }, [tasks]);
            React.useEffect(() => { localStorage.setItem('liferpg-rewards-v2', JSON.stringify(rewards)); }, [rewards]);
            React.useEffect(() => { localStorage.setItem('liferpg-history', JSON.stringify(history)); }, [history]);
            React.useEffect(() => { localStorage.setItem('liferpg-app-state', JSON.stringify(appState)); }, [appState]);
            React.useEffect(() => { localStorage.setItem('liferpg-daily-completions', JSON.stringify(dailyCompletions)); }, [dailyCompletions]);

            React.useEffect(() => {
                setRewards(prevRewards => prevRewards.map(r => {
                    if (r.category) return r;
                    let cat = 'shopping'; if (r.currency === 'stamina') cat = 'special'; else if (r.title.match(/Âñù|ÂêÉ|È§ê|ÈÖí|ËÇâ|Â§ñÈÄÅ|ÂûÉÂúæÈ£üÁâ©/)) cat = 'food'; else if (r.title.match(/Áù°|ÈõªÁé©|ÈÅäÊà≤|ÊîæÁ©∫|ÁôºÂëÜ|ÊªëÊâãÊ©ü|ÂíñÂï°|ÁÑ°ÊâÄ‰∫ã‰∫ã/)) cat = 'relax'; if (r.title.match(/Ë≤∑|È†êÁÆó|Á¶ÆÂåÖ|Ë™≤Èáë|Â∞èÁâ©|ÂÖßË§≤/)) cat = 'shopping'; return { ...r, category: cat };
                }));
                setTasks(prevTasks => prevTasks.map(t => { if (t.repeat === 'custom' && !t.lastCompleted) { const logs = history.filter(h => h.taskId === t.id || h.title === t.title); if (logs.length > 0) { logs.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)); return { ...t, lastCompleted: logs[0].completedAt, completed: true }; } } return t; }));
                const legacyCompleted = tasks.filter(t => t.completed && t.repeat !== 'custom').map(t => t.id);
                if (legacyCompleted.length > 0) { setDailyCompletions(prev => { const todayLog = prev[todayStr] || []; const merged = [...new Set([...todayLog, ...legacyCompleted])]; return { ...prev, [todayStr]: merged }; }); setTasks(prev => prev.map(t => t.repeat !== 'custom' ? { ...t, completed: false } : t)); }
                const checkAndReset = () => {
                    const now = new Date(); const nowString = now.toDateString(); const currentWeekNo = getWeekNumber(now); const nowISO = getISODate(now); const savedState = JSON.parse(localStorage.getItem('liferpg-app-state') || '{}'); const lastDate = savedState.lastVisitDate; const lastWeek = savedState.lastVisitWeek;
                    setTasks(prevTasks => prevTasks.map(t => {
                        if (t.repeat === 'daily') { let shouldReset = false; if (t.chain && (t.chainIndex > 0 || t.completed)) { if (t.lastCompleted) { if (getISODate(new Date(t.lastCompleted)) !== nowISO) shouldReset = true; } else { shouldReset = true; } } else if (t.completed) { shouldReset = true; } if (shouldReset) return { ...t, completed: false, chainIndex: 0, lastCompleted: undefined }; }
                        if (t.repeat === 'custom' && t.completed && t.lastCompleted) { const diffDays = Math.ceil(Math.abs(now - new Date(t.lastCompleted)) / (1000 * 60 * 60 * 24)); if (diffDays >= (t.frequency || 1)) return { ...t, completed: false }; }
                        return t;
                    }));
                    if (lastDate !== nowString) { setUser(prevUser => ({ ...prevUser, stamina: { ...prevUser.stamina, current: Math.min((prevUser.stamina?.max || 100), (prevUser.stamina?.current || 0) + 34) } })); setAppState({ lastVisitDate: nowString, lastVisitWeek: currentWeekNo }); if (lastDate !== nowString) showNotification("Ê≠°ËøéÂõû‰æÜÔºÅÁ≤æÂäõÂ∑≤ÊÅ¢Âæ© +34", "info"); }
                    if (lastWeek !== currentWeekNo) { setTasks(prevTasks => prevTasks.map(t => (t.repeat === 'weekly' ? { ...t, completed: false } : t))); setAppState(prev => ({ ...prev, lastVisitWeek: currentWeekNo })); }
                };
                checkAndReset();
                const handleVisibilityChange = () => { if (document.visibilityState === 'visible') { checkAndReset(); if (getISODate(new Date()) !== todayStr) window.location.reload(); } };
                document.addEventListener("visibilitychange", handleVisibilityChange); return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
            }, []);

            // --- Helper Functions ---
            const toggleSound = () => { const ns = !user.sound; setUser({...user, sound: ns}); window.soundEnabled = ns; if(ns) sfx.confirm(); };
            const toggleFavorite = (taskId) => { sfx.click(); setTasks(prev => prev.map(t => t.id === taskId ? { ...t, isFavorite: !t.isFavorite } : t)); };
            const handleUndoStep = (e, task) => { e.stopPropagation(); sfx.cancel(); setTasks(prev => prev.map(t => t.id === task.id ? { ...t, chainIndex: Math.max(0, (t.chainIndex || 0) - 1), completed: false } : t)); const stepData = task.chain[(task.chainIndex || 0) - 1]; if (stepData) { updateUserStatus(-stepData.xp, task.category, -(stepData.money || (stepData.xp * 2)), 0); showNotification(`Â∑≤Âæ©ÂéüÊ≠•È©ü (ÂõûÊî∂ XP & Zeny)`, "info"); } };
            const handleToggleTask = (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (task.chain && task.chain.length > 0) {
                    const currentIndex = task.chainIndex || 0;
                    if (currentIndex < task.chain.length) {
                        const stepData = task.chain[currentIndex]; const stepMoney = stepData.money !== undefined ? stepData.money : (stepData.xp * 2); updateUserStatus(stepData.xp, task.category, stepMoney, 0); setHistory(prev => [{ logId: Date.now(), taskId: task.id, title: `${task.title} - ${stepData.label}`, category: task.category, xp: stepData.xp, money: stepMoney, date: viewDateStr, completedAt: new Date().toISOString() }, ...prev]); sfx.step();
                        const nextIndex = currentIndex + 1; const isNowCompleted = nextIndex >= task.chain.length; const completionDate = new Date(viewDate); completionDate.setHours(12,0,0,0);
                        setTasks(prev => prev.map(t => t.id === taskId ? { ...t, chainIndex: nextIndex, completed: isNowCompleted, lastCompleted: completionDate.toISOString() } : t));
                        if (isNowCompleted) { sfx.success(); setDailyCompletions(prev => ({ ...prev, [viewDateStr]: [...(prev[viewDateStr] || []), taskId] })); showNotification("Á≥ªÂàó‰ªªÂãôÂÆåÊàêÔºÅ", "success"); } 
                    }
                    return;
                }
                const taskMoney = task.money !== undefined ? task.money : (task.xp * 2); const isCompleted = (dailyCompletions[viewDateStr] || []).includes(taskId);
                if (!isCompleted) {
                    sfx.success(); setDailyCompletions(prev => ({ ...prev, [viewDateStr]: [...(prev[viewDateStr] || []), taskId] })); const completionDate = new Date(viewDate); completionDate.setHours(12,0,0,0);
                    setTasks(prev => prev.map(t => t.id === taskId ? { ...t, completed: true, lastCompleted: completionDate.toISOString() } : t));
                    setHistory(prev => [{ logId: Date.now(), taskId: task.id, title: task.title, category: task.category, xp: task.xp, money: taskMoney, stamina: task.stamina||0, date: viewDateStr, completedAt: completionDate.toISOString() }, ...prev]);
                    updateUserStatus(task.xp, task.category, taskMoney, task.stamina||0); let notifMsg = `ÂÆåÊàêÔºÅÁç≤Âæó ${task.xp} XP, $${taskMoney} Z`; if (task.stamina > 0) notifMsg += `, +${task.stamina} STA`; showNotification(notifMsg, "success");
                    if (["ÊäÄÂ∏´", "Âü∑ÁÖß", "License", "ËΩâËÅ∑", "Job Change", "Â∑•Á®ãÂ∏´"].some(k => task.title.includes(k))) { setTimeout(() => { setNewJobTitle(""); setJobChangeData(task.title); sfx.levelup(); }, 800); }
                } else {
                    sfx.cancel(); setDailyCompletions(prev => ({ ...prev, [viewDateStr]: prev[viewDateStr].filter(id => id !== taskId) })); setTasks(prev => prev.map(t => t.id === taskId ? { ...t, completed: false } : t));
                    updateUserStatus(-task.xp, task.category, -taskMoney, -(task.stamina||0)); showNotification("Â∑≤Âæ©Âéü", "info");
                }
            };
            const changeDate = (offset) => { sfx.click(); const newDate = new Date(viewDate); newDate.setDate(newDate.getDate() + offset); setViewDate(newDate); };
            const jumpToToday = () => { sfx.click(); setViewDate(new Date()); };
            const handleRedeemReward = (reward) => { const cost = reward.cost || 0; const currency = reward.currency || 'zeny'; if (currency === 'zeny') { if (user.zeny < cost) { sfx.cancel(); showNotification("Zeny ‰∏çË∂≥ÔºÅ", "error"); return; } sfx.confirm(); updateUserStatus(0, "general", -cost); showNotification(`Â∑≤ÂÖåÊèõ ${reward.title}`, "gold"); setHistory(prev => [{ logId: Date.now(), title: `ÂÖåÊèõ: ${reward.title}`, category: "general", xp: 0, money: -cost, isReward: true, completedAt: new Date().toISOString() }, ...prev]); } else if (currency === 'stamina') { if ((user.stamina?.current || 0) < cost) { if (window.confirm(`Á≤æÂäõ‰∏çË∂≥ÔºÅË¶ÅÂº∑Ë°åÈáãÊîæÂóéÔºü(Êâ£ $2000 Z)`)) { const penalty = 2000; updateUserStatus(0, "general", -penalty, -user.stamina.current); showNotification(`È´îÂäõÈÄèÊîØ...`, "error"); sfx.cancel(); setHistory(prev => [{ logId: Date.now(), title: `‚ö† Âº∑Âà∂ÈáãÊîæ`, category: "general", xp: 0, money: -penalty, stamina: -Math.floor(user.stamina.current), isReward: true, completedAt: new Date().toISOString() }, ...prev]); } return; } else { sfx.success(); updateUserStatus(0, "general", 0, -cost); showNotification(`ËÅñ‰∫∫Ê®°Âºè`, "success"); setHistory(prev => [{ logId: Date.now(), title: `ÂÖåÊèõ: ${reward.title}`, category: "general", xp: 0, money: 0, stamina: -cost, isReward: true, completedAt: new Date().toISOString() }, ...prev]); } } };
            const confirmJobChange = () => { if (!newJobTitle.trim()) return; sfx.levelup(); setUser(prev => ({ ...prev, jobTitle: newJobTitle })); setJobChangeData(null); showNotification(`ËΩâËÅ∑ÊàêÂäüÔºÅ${newJobTitle}`, "gold"); };
            const updateUserStatus = (xpAmount, categoryKey, moneyAmount, staminaAmount = 0) => { const category = categories[categoryKey] || categories.general; const type = category.type; setUser(prev => { let s = { ...prev[type] }; let newXP = s.xp + xpAmount; let newLevel = s.level; let newMaxXp = s.maxXp; let leveledUp = false; if (xpAmount > 0) { while (newXP >= newMaxXp) { newXP -= newMaxXp; newLevel++; newMaxXp = Math.floor(newMaxXp * 1.2); leveledUp = true; } } else if (xpAmount < 0) { while (newXP < 0) { if (newLevel > 1) { newLevel--; newMaxXp = calculateMaxXP(newLevel); newXP += newMaxXp; } else { newXP = 0; break; } } } if (leveledUp) { setTimeout(() => { sfx.levelup(); setLevelUpData({ type, level: newLevel }); }, 100); } let newSta = Math.max(0, Math.min((prev.stamina?.max || 100), (prev.stamina?.current || 0) + staminaAmount)); return { ...prev, zeny: Math.max(0, (prev.zeny || 0) + moneyAmount), stamina: { ...prev.stamina, current: newSta }, [type]: { level: newLevel, xp: newXP, maxXp: newMaxXp } }; }); };
            const handleManualReset = () => { if(window.confirm("ÈáçÁΩÆÊØèÊó•‰ªªÂãôÔºü")) { sfx.confirm(); setDailyCompletions({}); showNotification("Â∑≤ÈáçÁΩÆ", "info"); setShowSettings(false); } };
            const handleHardReset = () => { if(confirm("„Äê‚ö†Ô∏è Âç±Èö™Êìç‰Ωú„Äë\nÈÄôÂ∞áÊ∏ÖÈô§ÊâÄÊúâË≥áÊñô‰∏¶ÈáçÁΩÆ„ÄÇ\nÁ¢∫ÂÆöÂóéÔºü")) { localStorage.clear(); location.reload(); } };
            const handleDeleteTask = (id) => { setTasks(tasks.filter(t => t.id !== id)); showNotification("Â∑≤Âà™Èô§", "error"); };
            const handleAddTask = (e) => { e.preventDefault(); if (!newTask.title.trim()) return; const moneyVal = parseInt(newTask.xp) * 2; const frequencyVal = parseInt(newTask.frequency) || 1; setTasks([...tasks, { id: Date.now(), title: newTask.title, category: newTask.category, xp: parseInt(newTask.xp), money: moneyVal, repeat: newTask.repeat, frequency: frequencyVal, isFavorite: false }]); setNewTask({ title: '', category: 'fitness', xp: 20, repeat: 'daily', frequency: 1 }); sfx.confirm(); showNotification("Êñ∞Â¢ûÊàêÂäü", "success"); };
            const handleAddReward = (e) => { e.preventDefault(); if (!newReward.title.trim()) return; setRewards([...rewards, { id: Date.now(), title: newReward.title, reqType: newReward.reqType, levelReq: parseInt(newReward.levelReq), cost: parseInt(newReward.cost || 0), currency: newReward.currency || 'zeny', category: newReward.category || 'shopping', unlocked: false }]); setNewReward(prev => ({ ...prev, title: '', cost: 100, currency: 'zeny' })); sfx.confirm(); showNotification("Êñ∞Â¢ûÁçéÂãµ", "success"); };
            const handleDeleteReward = (id) => { setRewards(rewards.filter(r => r.id !== id)); };
            const handleClearHistory = () => { if(window.confirm("Ê∏ÖÈô§Á¥ÄÈåÑÔºü")) { setHistory([]); setDailyCompletions({}); showNotification("Â∑≤Ê∏ÖÈô§", "info"); setShowSettings(false); } };
            const handleExportData = () => { sfx.confirm(); const data = { user, tasks, rewards, history, appState, dailyCompletions, version: "5.8" }; const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `liferpg_backup.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); showNotification("ÂÇô‰ªΩÂ∑≤‰∏ãËºâ", "success"); };
            const handleImportData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if(data.user) setUser({...data.user, name: data.user.name || "Player", jobTitle: data.user.jobTitle || "Â∑•Á®ãÂ∏´", zeny: data.user.zeny || 0, stamina: data.user.stamina || {current:100, max:100}, sound: data.user.sound !== undefined ? data.user.sound : true}); if(data.tasks) setTasks(data.tasks); if(data.rewards) setRewards(data.rewards); if(data.history) setHistory(data.history); if(data.dailyCompletions) setDailyCompletions(data.dailyCompletions); if(data.appState) setAppState(data.appState); sfx.success(); showNotification("ÈÇÑÂéüÊàêÂäü", "success"); setShowSettings(false); } catch (err) { showNotification("Ê†ºÂºèÈåØË™§", "error"); } }; reader.readAsText(file); };
            const mergePack = (pack, name) => { const currentTasks = Array.isArray(tasks) ? tasks : []; const newT = pack.filter(n => !currentTasks.some(e => e.title.trim() === n.title.trim())).map(t => ({...t, id: Date.now() + Math.random(), isFavorite: false})); if (newT.length === 0) { showNotification("‰ªªÂãôÂ∑≤Â≠òÂú®", "info"); return; } setTasks(p => [...p, ...newT]); sfx.confirm(); showNotification(`Â∑≤ÂåØÂÖ• ${name}`, "success"); }
            const handleImportStarterPack = () => mergePack([{ id: 1001, title: "ÈÅõÁãó", category: "fitness", xp: 30, money: 50, repeat: 'daily' }, { id: 1002, title: "ÂÅ•Ë∫´/ÈÅãÂãï", category: "fitness", xp: 50, money: 100, stamina: 34, repeat: 'daily' }, { id: 1008, title: "üíß ÂñùÊ∞¥", category: "fitness", xp: 5, money: 5, repeat: 'daily', chainIndex: 0, chain: [{ label: "600cc", xp: 5, money: 5 }, { label: "1200cc", xp: 5, money: 5 }, { label: "2000cc (ÂÆåÊàê)", xp: 10, money: 20 }] }, { id: 1014, title: "ÂçàÈ§êÂæåÂà∑Áâô", category: "fitness", xp: 10, money: 20, repeat: 'daily' }, { id: 1009, title: "Ê™¢Ë¶ñÈñãÈä∑", category: "finance", xp: 20, money: 30, repeat: 'daily' }], "Êñ∞ÊâãÂåÖ");
            const handleImportEngineerPack = () => { if(!window.confirm("ÂåØÂÖ•Áí∞Â∑•ËàáÁêÜË≤°‰ªªÂãôÔºü")) return; mergePack([ { id: 2001, title: "ËÄÉÂèñÁí∞Â∑•ÊäÄÂ∏´Âü∑ÁÖß (PE)", category: "knowledge", xp: 100, money: 2000, repeat: 'none' }, { id: 2004, title: "Áï™ËåÑÈêòÁí∞Ë©ï (4x25m)", category: "knowledge", xp: 20, money: 40, repeat: 'daily' }, { id: 2006, title: "Èõ∂ÊîØÂá∫ÊåëÊà∞", category: "finance", xp: 30, money: 60, repeat: 'daily' }, { id: 2008, title: "ËΩâÂ∏≥Â∑•Á®ãÊ¨æ", category: "finance", xp: 50, money: 200, repeat: 'weekly' } ], "Áí∞Â∑•ÂåÖ"); };
            const handleImportUpgradePack = () => { mergePack([ { id: 3003, title: "Êõ¥Êñ∞Â±•Ê≠∑/‰ΩúÂìÅÈõÜ", category: "knowledge", xp: 50, money: 200, repeat: 'none' }, { id: 3004, title: "Ê†∏Â∞ç‰ø°Áî®Âç°Â∏≥ÂñÆ", category: "finance", xp: 20, money: 40, repeat: 'weekly' }, { id: 3005, title: "Êü•Ë©¢ÊàøË≤∏Âà©Áéá/ÊîøÁ≠ñ", category: "finance", xp: 20, money: 40, repeat: 'weekly' }, { id: 3008, title: "Êñ∑Êç®Èõ¢Ôºö‰∏üÊéâ 3 Ê®£ÈõúÁâ©", category: "chores", xp: 20, money: 30, repeat: 'weekly' }, { id: 3011, title: "Á†îËÆÄÁí∞Â∑•Ëã±Êñá/ÊúÄÊñ∞Ê≥ïË¶è 30ÂàÜÈêò", category: "knowledge", xp: 30, money: 50, repeat: 'weekly' }, { id: 3014, title: "‰∏üÂûÉÂúæ", category: "chores", xp: 10, money: 20, repeat: 'daily' }, { id: 3015, title: "Ââ™È†≠È´Æ (ÊØè3ÈÄ±)", category: "general", xp: 50, money: 100, repeat: 'custom', frequency: 21 }, { id: 3016, title: "Ââ™ÊåáÁî≤ (ÊØè2ÈÄ±)", category: "fitness", xp: 20, money: 40, repeat: 'custom', frequency: 14 }, { id: 3020, title: "ÊèõÂ∫äÂñÆ", category: "chores", xp: 40, money: 80, repeat: 'custom', frequency: 7 }, { id: 3021, title: "Áî®ÁâôÁ∑ö (ÊØèÊôö)", category: "fitness", xp: 10, money: 20, repeat: 'daily' }, { id: 3022, title: "Êà¥Á∂≠ÊåÅÂô® (ÊØèÊôö)", category: "fitness", xp: 10, money: 20, repeat: 'daily' }, { id: 3023, title: "ÂêÉËá™ÂÇô‰ΩéGIÈ§ê (Âçà)", category: "fitness", xp: 20, money: 40, repeat: 'daily' }, { id: 3024, title: "ÂêÉËá™ÂÇô‰ΩéGIÈ§ê (Êôö)", category: "fitness", xp: 20, money: 40, repeat: 'daily' }, { id: 3025, title: "Êë∫Ë°£Êúç", category: "chores", xp: 20, money: 40, repeat: 'custom', frequency: 7 }, { id: 3026, title: "Âê∏Âú∞", category: "chores", xp: 20, money: 40, repeat: 'custom', frequency: 3 }, { id: 3027, title: "ÊãñÂú∞", category: "chores", xp: 30, money: 60, repeat: 'custom', frequency: 7 }, { id: 3028, title: "Ê¥óÈÅõÁãóËÉåÂ∏∂", category: "chores", xp: 20, money: 40, repeat: 'custom', frequency: 7 } ], "ÂçáÁ¥öÂåÖ"); };
            const handleImportRewardPack = () => { const rewardPack = [ { id: 4002, title: "Âñù‰∏ÄÊùØÊâãÊêñÈ£≤ (Âä†Êñô!)", reqType: 'base', levelReq: 3, cost: 80, currency: 'zeny', category: 'food', unlocked: false }, { id: 4032, title: "„ÄåÁÑ°ËÖ¶ÂûÉÂúæÈ£üÁâ©„ÄçÈ°çÂ∫¶ÔºàÂ∞è‰ªΩÔºâ", reqType: 'base', levelReq: 2, cost: 200, currency: 'zeny', category: 'food', unlocked: false }, { id: 1, title: "ÊîæÁ∏±È§ê", reqType: 'base', levelReq: 2, cost: 600, currency: 'zeny', category: 'food', unlocked: false }, { id: 4006, title: "ÈÄ±Êú´Â∞èÈÖå‰∏ÄÊùØ", reqType: 'base', levelReq: 4, cost: 300, currency: 'zeny', category: 'food', unlocked: false }, { id: 4040, title: "Â§ñÈÄÅ‰ΩøÁî®Âà∏ (ÂÖçÈÅã/ÊúçÂãôË≤ª)", reqType: 'base', levelReq: 2, cost: 150, currency: 'zeny', category: 'food', unlocked: false }, { id: 4041, title: "È´òÂìÅË≥™ÂéüËÇâÈ†êÁÆó ($500)", reqType: 'job', levelReq: 3, cost: 800, currency: 'zeny', category: 'food', unlocked: false }, { id: 4001, title: "ÁÑ°ÁΩ™ÊÉ°ÊÑüÊâìÈõªÂãï 1Â∞èÊôÇ", reqType: 'base', levelReq: 1, cost: 150, currency: 'zeny', category: 'relax', unlocked: false }, { id: 4003, title: "ÈÄ±Êú´Áù°Âà∞Ëá™ÁÑ∂ÈÜí", reqType: 'base', levelReq: 2, cost: 200, currency: 'zeny', category: 'relax', unlocked: false }, { id: 4004, title: "ÁÑ°ÊâÄ‰∫ã‰∫ã (Á¥îÊîæÁ©∫ 1Â∞èÊôÇ)", reqType: 'base', levelReq: 1, cost: 100, currency: 'zeny', category: 'relax', unlocked: false }, { id: 4030, title: "„ÄåÂÆåÂÖ®Âª¢‰∫∫„ÄçÊªëÊâãÊ©üÂà∏Ôºà30ÂàÜÈêòÔºâ", reqType: 'base', levelReq: 1, cost: 50, currency: 'zeny', category: 'relax', unlocked: false }, { id: 4031, title: "„ÄåÊö´ÂÅúÂ§ßËÖ¶„ÄçÁôºÂëÜÂà∏Ôºà15ÂàÜÈêòÔºâ", reqType: 'base', levelReq: 1, cost: 30, currency: 'zeny', category: 'relax', unlocked: false }, { id: 4005, title: "ÂéªÂíñÂï°Âª≥ÁôºÂëÜ/Èñ±ËÆÄ", reqType: 'base', levelReq: 3, cost: 250, currency: 'zeny', category: 'relax', unlocked: false }, { id: 4020, title: "Âπ≥ÂÉπÂÖßË§≤È†êÁÆó ($500)", reqType: 'job', levelReq: 2, cost: 800, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 4024, title: "Â∞àÊ´ÉÂÖßË§≤È†êÁÆó ($1000)", reqType: 'job', levelReq: 7, cost: 3500, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 4025, title: "È´òÁ¥öÂÖßË§≤Á¶ÆÂåÖ ($5000)", reqType: 'job', levelReq: 15, cost: 6000, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 4022, title: "Steam/ÈÅäÊà≤Ë™≤Èáë ($500ÂÖß)", reqType: 'job', levelReq: 4, cost: 3000, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 2, title: "Ë≤∑Êñ∞ÈÅäÊà≤", reqType: 'job', levelReq: 5, cost: 3000, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 4010, title: "Êñ∞ÂÆ∂ËªüË£ùÂ∞èÁâ© ($1000ÂÖß)", reqType: 'job', levelReq: 6, cost: 5000, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 4042, title: "ÂÅ•Ë∫´ÂìÅÁâåÊúçÈ£æÈ†êÁÆó", reqType: 'job', levelReq: 5, cost: 3000, currency: 'zeny', category: 'shopping', unlocked: false }, { id: 999, title: "ËÅñ‰∫∫Ê®°Âºè (ÈáãÊîæ)", reqType: 'base', levelReq: 1, cost: 100, currency: 'stamina', category: 'special', unlocked: true } ]; const currentRewards = Array.isArray(rewards) ? rewards : []; const newR = rewardPack.filter(n => !currentRewards.some(e => e.title.trim() === n.title.trim())).map(r => ({...r, id: Date.now() + Math.random()})); if (newR.length === 0) { showNotification("ÁçéÂãµÂ∑≤Â≠òÂú®", "info"); return; } setRewards(p => [...p, ...newR]); showNotification(`ÊàêÂäüÂåØÂÖ•ÁçéÂãµÂåÖ`, "success"); };
            
            const getHistoryByDate = () => { const groups = {}; history.forEach(entry => { const date = new Date(entry.completedAt).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', weekday: 'short' }); if (!groups[date]) groups[date] = []; groups[date].push(entry); }); return groups; };
            const renderTaskSection = (taskList, title, bgClass = "") => { if (taskList.length === 0) return null; return ( <div className="mb-4 animate-slide-in"> <h3 className={`text-[10px] font-bold uppercase tracking-widest mb-2 border-b pb-1 ${bgClass ? bgClass : 'text-slate-400 border-slate-700'}`}>{title}</h3> <div className="space-y-2"> {taskList.map(task => renderTaskItem(task))} </div> </div> ); };
            const renderRewardSection = (rewardList, title, colorClass) => { if (rewardList.length === 0) return null; return ( <div className="mb-4 animate-slide-in"> <h3 className={`text-[10px] font-bold uppercase tracking-widest mb-2 border-b pb-1 ${colorClass}`}>{title}</h3> <div className="grid grid-cols-1 gap-2"> {rewardList.map(reward => { const isUnlocked = (reward.reqType === 'base' ? user.base.level : user.job.level) >= reward.levelReq; const cost = reward.cost || 0; const currency = reward.currency || 'zeny'; const canAfford = currency === 'zeny' ? (user.zeny || 0) >= cost : (user.stamina?.current || 0) >= cost; return ( <div key={reward.id} className={`relative p-3 ro-window flex items-center justify-between ${isUnlocked ? 'bg-white' : 'bg-gray-200 opacity-80'}`}> <div className="flex items-center gap-3 min-w-0"> <div className={`p-1.5 rounded shrink-0 ${isUnlocked ? (currency === 'stamina' ? 'text-emerald-600 bg-emerald-100' : 'text-blue-600 bg-blue-100') : 'text-slate-400 bg-slate-200'}`}>{isUnlocked ? <ShoppingBag size={16} /> : <Lock size={16} />}</div> <div className="min-w-0"> <h3 className="font-bold text-sm text-slate-700 truncate">{reward.title}</h3> <div className="flex items-center gap-2 text-[10px]"><span className={`font-pixel whitespace-nowrap ${isUnlocked ? (canAfford ? (currency === 'stamina' ? 'text-emerald-600 font-bold' : 'text-yellow-600 font-bold') : 'text-red-500') : 'text-slate-400'}`}>{currency === 'stamina' ? `${cost} STA` : `$${cost} Z`}</span>{!isUnlocked && <span className="text-red-400 whitespace-nowrap">Req: Lv.{reward.levelReq}</span>}</div> </div> </div> {isUnlocked ? <Button onClick={() => handleRedeemReward(reward)} variant={canAfford ? (currency === 'stamina' ? "primary" : "green") : "outline"} disabled={!canAfford && currency === 'zeny'} className="text-xs py-1 px-2 ml-2 shrink-0">Ë≥ºË≤∑</Button> : <button onClick={() => handleDeleteReward(reward.id)} className="text-slate-400 hover:text-red-500 ml-2 shrink-0"><Trash2 size={14} /></button>} </div> ); })} </div> </div> ); }
            const renderTaskItem = (task) => { const cat = categories[task.category] || categories.general; const xpType = cat.type === 'base' ? 'Base' : 'Job'; const moneyReward = task.money || (task.xp * 2); const isCompleted = (dailyCompletions[viewDateStr] || []).includes(task.id); let repeatLabel = ""; if (task.repeat === 'custom' && task.frequency) repeatLabel = `ÊØè${task.frequency}Â§©`; if (task.repeat === 'weekend') repeatLabel = `ÈÄ±Êú´`; if (task.repeat === 'weekly') repeatLabel = `ÊØèÈÄ±`; let displayTitle = task.title; let displayXP = task.xp; let displayMoney = moneyReward; let chainStepLabel = ""; if (task.chain) { const currentStepIndex = Math.min(task.chainIndex || 0, task.chain.length - 1); const stepData = task.chain[currentStepIndex]; if (isCompleted) { displayTitle = `${task.title} - ÂÆåÊàê`; chainStepLabel = `(${task.chain.length}/${task.chain.length})`; } else { displayTitle = `${task.title} - ${stepData.label}`; chainStepLabel = `(${currentStepIndex + 1}/${task.chain.length})`; displayXP = stepData.xp; displayMoney = stepData.money !== undefined ? stepData.money : (stepData.xp * 2); } } let dueLabel = ""; if (task.repeat === 'custom' && task.lastCompleted && isCompleted) { const getDaysDiff = (date1, date2) => { const d1 = new Date(date1); d1.setHours(0,0,0,0); const d2 = new Date(date2); d2.setHours(0,0,0,0); return Math.floor((d1 - d2) / (1000 * 60 * 60 * 24)); }; const lastDate = new Date(task.lastCompleted); const today = new Date(); const diffDays = getDaysDiff(today, lastDate); const daysLeft = (task.frequency || 1) - diffDays; if (daysLeft > 0) dueLabel = ` (${daysLeft}Â§©Âæå)`; } return ( <div key={task.id} className={`relative flex items-center justify-between p-3 ro-window ${isCompleted ? 'opacity-50 bg-gray-300 border-gray-400' : 'bg-white'}`}> <div className="flex items-center gap-3 flex-1 min-w-0"> <button onClick={(e) => { e.stopPropagation(); toggleFavorite(task.id); }} className={`shrink-0 ${task.isFavorite ? 'text-yellow-400' : 'text-slate-300 hover:text-yellow-200'}`} > <StarIcon size={16} fill={task.isFavorite ? "currentColor" : "none"} /> </button> <button onClick={(e) => handleToggleTask(task.id)} className={`shrink-0 h-6 w-6 rounded shadow-sm flex items-center justify-center border transition-all active:scale-95 ${isCompleted ? 'bg-green-100 border-green-300 text-green-600' : 'bg-white border-slate-300 text-slate-300 hover:border-blue-400'}`} > {isCompleted && <CheckCircle2 size={14} />} </button> {task.chain && (task.chainIndex || 0) > 0 && !isCompleted && ( <button onClick={(e) => handleUndoStep(e, task)} className="absolute left-14 -ml-1 text-slate-400 hover:text-red-400"> <RotateCcw size={10} /> </button> )} <div className="min-w-0 flex-1"> <div className="flex items-center gap-2 mb-0.5"> <span className={`text-[9px] px-1 rounded border ${cat.bg} flex items-center gap-1`}>{cat.icon} {cat.label}</span> <span className="text-[10px] font-pixel text-slate-500">+{displayXP} {xpType}</span> <span className="text-[10px] font-pixel text-yellow-600 bg-yellow-50 px-1 rounded border border-yellow-200">+${displayMoney} Z</span> {task.stamina > 0 && <span className="text-[10px] font-pixel text-emerald-600 bg-emerald-50 px-1 rounded border border-emerald-200">+{task.stamina} STA</span>} </div> <div className="flex items-center gap-2"> <h3 className={`font-bold text-sm truncate ${isCompleted ? 'line-through text-slate-500' : 'text-slate-800'}`}>{displayTitle} <span className="text-[10px] text-slate-500 font-normal">{chainStepLabel}</span></h3> {(repeatLabel || dueLabel) && <span className="text-[9px] text-slate-400 bg-slate-100 px-1 rounded border border-slate-200">{repeatLabel}{dueLabel}</span>} </div> </div> </div> <button onClick={() => handleDeleteTask(task.id)} className="ml-2 text-slate-400 hover:text-red-500"><Trash2 size={14} /></button> </div> ); };
            
            // --- NEW Filter Logic for v5.8 ---
            const getFilteredTaskLists = () => { 
                // 1. Filter by Main Category (e.g. Base/Job) from Filter Buttons
                let baseList = tasks.filter(task => { 
                    const cat = categories[task.category] || categories.general; 
                    if (questFilter !== 'all' && cat.type !== questFilter) return false; 
                    const viewDay = viewDate.getDay(); 
                    const isWeekendView = viewDay === 0 || viewDay === 6; 
                    if (task.repeat === 'weekend' && !isWeekendView) return false; 
                    return true; 
                }); 
                
                const completedIds = dailyCompletions[viewDateStr] || []; 
                
                // 2. Active vs Completed
                const activeList = baseList.filter(t => !completedIds.includes(t.id)); 
                const completedList = baseList.filter(t => completedIds.includes(t.id)); 
                
                // 3. Extract Favorites
                const favorites = activeList.filter(t => t.isFavorite); 
                
                // 4. Others (Grouped by Category later)
                const others = activeList.filter(t => !t.isFavorite); 
                
                return { favorites, others, completedList }; 
            };
            
            const { favorites, others, completedList } = getFilteredTaskLists();
            const getFilteredRewards = () => { const grouped = { food: [], relax: [], shopping: [], special: [], other: [] }; rewards.forEach(r => { if (grouped[r.category]) grouped[r.category].push(r); else grouped.other.push(r); }); return grouped; }
            const groupedRewards = getFilteredRewards();
            const renderCalendar = () => { const year = viewDate.getFullYear(); const month = viewDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay(); const days = []; for (let i = 0; i < firstDay; i++) days.push(<div key={`pad-${i}`} />); for (let i = 1; i <= daysInMonth; i++) { const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; const isSelected = dateStr === viewDateStr; const hasData = dailyCompletions[dateStr] && dailyCompletions[dateStr].length > 0; days.push( <button key={i} onClick={() => { sfx.click(); setViewDate(new Date(dateStr)); setShowCalendar(false); }} className={`calendar-day ${isSelected ? 'selected' : 'hover:bg-slate-300'} ${hasData ? 'has-data' : ''} ${dateStr === todayStr ? 'today' : ''}`} > {i} </button> ); } return days; };
            const switchTab = (tab) => { sfx.click(); setActiveTab(tab); }

            // --- RENDER ---
            return (
                <div className="w-full min-h-full flex flex-col text-sm">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {/* Header with CLOCK */}
                    <div className="sticky top-0 z-30 w-full pt-safe px-3 pb-2 shrink-0" style={{background: '#2d3748'}}>
                        <div className="ro-window p-3 space-y-2 max-w-lg mx-auto">
                            <div className="flex items-center justify-between bg-slate-700/50 rounded p-1.5 border border-slate-600 mb-1">
                                <div className="flex items-center gap-2"><Clock size={14} className="text-blue-300" /><span className="font-pixel text-lg text-white tracking-widest">{timeString}</span></div>
                                <div className="flex items-center gap-3"><button onClick={toggleWorkMode} className={`flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold transition-colors border ${clockStats.isWorkingDay ? 'bg-blue-900/80 text-blue-200 border-blue-700' : 'bg-green-900/80 text-green-200 border-green-700'}`}>{clockStats.isWorkingDay ? <Briefcase size={10} /> : <Coffee size={10} />} {clockStats.isWorkingDay ? "‰∏äÁè≠Êó•" : "‰ºëÂÅáÊó•"}</button><div className="flex items-center gap-1 text-xs font-bold text-slate-300"><Moon size={12} className={clockStats.status === 'sleep' ? 'text-slate-500' : 'text-yellow-200'} />{clockStats.status === 'sleep' ? <span className="text-slate-500">‰ºëÊÅØ‰∏≠</span> : <span className={clockStats.hours < 2 ? 'text-red-400' : 'text-white'}>{clockStats.hours}h {clockStats.mins}m <span className="text-[9px] text-slate-400 ml-1 font-normal">Ëá™Áî±</span></span>}</div></div>
                            </div>
                            
                            <div className="flex flex-wrap items-start justify-between border-b border-slate-300 pb-1 mb-1">
                                <div className="flex flex-col mr-auto"><h1 className="text-base font-bold text-blue-900 flex items-center gap-2">Player Status</h1></div>
                                <div className="flex items-center gap-2 ml-auto mt-1 sm:mt-0"><div className="bg-white/80 border border-slate-400 rounded px-2 py-0.5 text-xs font-pixel flex items-center gap-1"><span className="text-yellow-600 font-bold">Z</span><span>{user.zeny || 0}</span></div><button onClick={() => {sfx.click(); setShowSettings(true);}} className="text-slate-500 hover:text-blue-600"><Settings size={16} /></button></div>
                            </div>
                            <div className="flex justify-between items-end px-1">
                                <div><div className="text-sm font-bold text-slate-800">{user.name}</div><div className="text-xs font-bold text-blue-700 flex items-center gap-1"><Crown size={12} className="text-yellow-500" /> {user.jobTitle}</div></div>
                                <div className="text-[10px] text-slate-500 font-pixel text-right">{todayDate}</div>
                            </div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-700 w-14 shrink-0">Base Lv.</span><ProgressBar current={user.base.xp} max={user.base.maxXp} height="h-3" /><span className="text-xs font-bold w-8 text-right font-pixel">{user.base.level}</span></div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-700 w-14 shrink-0">Job Lv.</span><ProgressBar current={user.job.xp} max={user.job.maxXp} height="h-3" /><span className="text-xs font-bold w-8 text-right font-pixel">{user.job.level}</span></div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold text-emerald-700 w-14 shrink-0">STA</span><ProgressBar current={user.stamina?.current || 0} max={user.stamina?.max || 100} height="h-3" type="stamina" /><span className="text-xs font-bold w-8 text-right font-pixel">{Math.floor(user.stamina?.current || 0)}</span></div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 w-full max-w-lg mx-auto p-3 pb-32 overflow-x-hidden">
                        <div className="grid grid-cols-3 gap-2 mb-4 w-full">
                            <button onClick={() => switchTab('tasks')} className={`ro-btn-base py-2 rounded text-xs font-bold flex items-center justify-center gap-1 ${activeTab === 'tasks' ? 'bg-blue-200 text-blue-900 border-blue-400' : 'bg-white text-slate-600 border-slate-300'}`}><CheckCircle2 size={14} /> ‰ªªÂãô</button>
                            <button onClick={() => switchTab('rewards')} className={`ro-btn-base py-2 rounded text-xs font-bold flex items-center justify-center gap-1 ${activeTab === 'rewards' ? 'bg-amber-200 text-amber-900 border-amber-400' : 'bg-white text-slate-600 border-slate-300'}`}><ShoppingBag size={14} /> ÂïÜÂ∫ó</button>
                            <button onClick={() => switchTab('history')} className={`ro-btn-base py-2 rounded text-xs font-bold flex items-center justify-center gap-1 ${activeTab === 'history' ? 'bg-teal-200 text-teal-900 border-teal-400' : 'bg-white text-slate-600 border-slate-300'}`}><Calendar size={14} /> Á¥ÄÈåÑ</button>
                        </div>

                        {activeTab === 'tasks' && (
                            <div className="space-y-4 animate-slide-in">
                                {/* Date Nav */}
                                <div className="flex items-center justify-between bg-slate-700/50 p-2 rounded border border-slate-600">
                                    <button onClick={() => changeDate(-1)} className="text-white hover:text-blue-300"><ChevronLeft size={20} /></button>
                                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => {sfx.click(); setShowCalendar(true);}}><span className={`font-bold font-pixel text-base ${!isToday ? 'text-yellow-400' : 'text-white'}`}>{viewDateStr}</span><Calendar size={14} className="text-slate-300"/></div>
                                    <div className="flex items-center gap-2">{!isToday && <button onClick={jumpToToday} className="text-[10px] bg-slate-600 px-2 py-1 rounded text-white hover:bg-slate-500">ÂõûÂà∞‰ªäÂ§©</button>}<button onClick={() => changeDate(1)} className={`text-white hover:text-blue-300 ${isToday ? 'invisible' : ''}`}><ChevronRight size={20} /></button></div>
                                </div>

                                {/* Filter */}
                                <div className="grid grid-cols-3 gap-2 mb-2 w-full">
                                    <button onClick={() => {sfx.click(); setQuestFilter('all');}} className={`py-1.5 rounded-full text-[10px] font-bold border text-center w-full ${questFilter === 'all' ? 'bg-blue-600 text-white border-blue-700' : 'bg-white text-slate-500 border-slate-300'}`}>ÂÖ®ÈÉ®</button>
                                    <button onClick={() => {sfx.click(); setQuestFilter('base');}} className={`py-1.5 rounded-full text-[10px] font-bold border text-center w-full ${questFilter === 'base' ? 'bg-red-500 text-white border-red-600' : 'bg-white text-slate-500 border-slate-300'}`}>ÁîüÊ¥ª (Base)</button>
                                    <button onClick={() => {sfx.click(); setQuestFilter('job');}} className={`py-1.5 rounded-full text-[10px] font-bold border text-center w-full ${questFilter === 'job' ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-300'}`}>ËÅ∑Ê∂Ø (Job)</button>
                                </div>

                                {/* Task Form */}
                                <Card title="Quest Board">
                                    <div className="flex flex-col gap-2">
                                        <input type="text" placeholder="Êñ∞‰ªªÂãô..." className="w-full px-2 py-1.5 min-w-0" value={newTask.title} onChange={(e) => setNewTask({...newTask, title: e.target.value})} />
                                        <div className="grid grid-cols-2 gap-2">
                                            <select className="px-1 py-1.5 text-xs min-w-0" value={newTask.category} onChange={(e) => setNewTask({...newTask, category: e.target.value})}>{Object.entries(categories).map(([key, val]) => <option key={key} value={key}>{val.label}</option>)}</select>
                                            <select className="px-1 py-1.5 text-xs min-w-0" value={newTask.repeat} onChange={(e) => setNewTask({...newTask, repeat: e.target.value})}><option value="daily">ÊØèÊó•</option><option value="weekly">ÊØèÈÄ±</option><option value="weekend">ÈÄ±Êú´</option><option value="custom">Ëá™ÂÆöÁæ©</option><option value="none">‰∏ÄÊ¨°</option></select>
                                        </div>
                                        {newTask.repeat === 'custom' && (
                                            <div className="flex items-center gap-2 bg-slate-700 p-1.5 rounded border border-slate-600">
                                                <span className="text-[10px] text-slate-300 whitespace-nowrap">ÊØè</span>
                                                <input type="number" min="1" className="w-12 px-1 py-0.5 text-center text-xs bg-slate-800 text-white rounded border border-slate-500" value={newTask.frequency || ''} onChange={(e) => setNewTask({...newTask, frequency: e.target.value})} placeholder="Â§©Êï∏" />
                                                <span className="text-[10px] text-slate-300 whitespace-nowrap">Â§©ÈáçÁΩÆ</span>
                                            </div>
                                        )}
                                        <div className="flex gap-2">
                                             <select className="flex-1 px-1 py-1.5 text-xs min-w-0" value={newTask.xp} onChange={(e) => setNewTask({...newTask, xp: e.target.value})}><option value="10">10 XP ($20Z)</option><option value="20">20 XP ($40Z)</option><option value="30">30 XP ($60Z)</option><option value="50">50 XP ($100Z)</option></select>
                                            <Button variant="primary" onClick={handleAddTask} className="flex-1 text-xs"><Plus size={14} /> Êé•Âèó</Button>
                                        </div>
                                    </div>
                                </Card>

                                <div className="flex flex-wrap justify-end gap-2">
                                    <button onClick={handleImportUpgradePack} className="ro-btn-base px-2 py-1.5 rounded text-xs font-bold flex items-center gap-1 bg-slate-700 text-yellow-300 border border-slate-600 hover:bg-slate-600"><Sparkles size={12} /> ÂçáÁ¥öÂåÖ</button>
                                    <button onClick={handleImportEngineerPack} className="ro-btn-base px-2 py-1.5 rounded text-xs font-bold flex items-center gap-1 bg-slate-700 text-cyan-300 border border-slate-600 hover:bg-slate-600"><HardHat size={12} /> Áí∞Â∑•ÂåÖ</button>
                                    <button onClick={handleImportStarterPack} className="ro-btn-base px-2 py-1.5 rounded text-xs font-bold flex items-center gap-1 bg-slate-700 text-indigo-300 border border-slate-600 hover:bg-slate-600"><Download size={12} /> Êñ∞ÊâãÂåÖ</button>
                                </div>

                                {/* CATEGORIZED Task List */}
                                <div className="space-y-6 pb-12">
                                    {favorites.length === 0 && others.length === 0 && completedList.length === 0 && <div className="text-center py-8 text-slate-400 text-xs">ÁÑ°‰ªªÂãô</div>}
                                    
                                    {/* 1. Favorites First */}
                                    {renderTaskSection(favorites, "üåü ÈóúÊ≥®‰ªªÂãô", "text-yellow-500 border-yellow-700")}

                                    {/* 2. Group by Categories */}
                                    {Object.entries(categories).map(([key, cat]) => {
                                        const catTasks = others.filter(t => t.category === key);
                                        return renderTaskSection(catTasks, `${cat.label}`, cat.bg);
                                    })}

                                    {/* 3. Completed */}
                                    {completedList.length > 0 && (
                                        <div className="opacity-60 grayscale-[0.5]">
                                            {renderTaskSection(completedList, "‚úÖ Â∑≤ÂÆåÊàê")}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* Rewards & History Tabs (unchanged) */}
                        {activeTab === 'rewards' && (
                            <div className="space-y-4 animate-slide-in">
                                <Card title="Item Shop">
                                    <div className="flex flex-col gap-2">
                                        <input type="text" placeholder="ÂïÜÂìÅÂêçÁ®±..." className="w-full px-2 py-1.5 min-w-0 truncate" value={newReward.title} onChange={(e) => setNewReward({...newReward, title: e.target.value})} />
                                        <div className="grid grid-cols-2 gap-2">
                                            <select className="col-span-1 px-1 py-1.5 text-xs min-w-0" value={newReward.reqType} onChange={(e) => setNewReward({...newReward, reqType: e.target.value})}><option value="base">Req: Base Lv</option><option value="job">Req: Job Lv</option></select>
                                            <input type="number" placeholder="Á≠âÁ¥öÈúÄÊ±Ç" className="col-span-1 px-2 py-1.5 min-w-0" value={newReward.levelReq} onChange={(e) => setNewReward({...newReward, levelReq: e.target.value})} />
                                        </div>
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="ÂÉπÊ†º ($Z)" className="flex-1 px-2 py-1.5 min-w-0" value={newReward.cost || ''} onChange={(e) => setNewReward({...newReward, cost: e.target.value})} />
                                            <select className="w-20 shrink-0 px-1 py-1.5 text-xs" value={newReward.currency} onChange={(e) => setNewReward({...newReward, currency: e.target.value})}><option value="zeny">Zeny</option><option value="stamina">STA</option></select>
                                        </div>
                                        <Button variant="primary" onClick={handleAddReward} className="w-full py-2 text-xs"><Plus size={14} /> ‰∏äÊû∂ÂïÜÂìÅ</Button>
                                    </div>
                                </Card>
                                <div className="flex justify-end"><button onClick={handleImportRewardPack} className="ro-btn-base px-2 py-1.5 rounded text-xs font-bold flex items-center gap-1 bg-slate-700 text-pink-300 border border-slate-600 hover:bg-slate-600"><Gift size={12} /> ÁçéÂãµÂåÖ</button></div>
                                <div className="space-y-4">
                                    {renderRewardSection(groupedRewards.food, "üçî È£≤È£ü‰∫´Âèó", rewardCategories.food.color)}
                                    {renderRewardSection(groupedRewards.relax, "üí§ ‰ºëÊÅØÊîæÈ¨Ü", rewardCategories.relax.color)}
                                    {renderRewardSection(groupedRewards.shopping, "üõçÔ∏è Ë≥ºÁâ©ÁäíË≥û", rewardCategories.shopping.color)}
                                    {renderRewardSection(groupedRewards.special, "‚ú® ÁâπÊÆäÂäüËÉΩ", rewardCategories.special.color)}
                                    {renderRewardSection(groupedRewards.other, "üì¶ ÂÖ∂‰ªñ", "text-slate-600 border-slate-300")}
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                             <div className="space-y-4 animate-slide-in">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="text-xs font-bold text-slate-400 uppercase">Adventure Log</h2>
                                    <button onClick={handleClearHistory} className="text-[10px] text-slate-500 hover:text-red-500 flex items-center gap-1"><Trash2 size={10} /> Ê∏ÖÈô§</button>
                                </div>
                                {history.length === 0 ? <div className="text-center py-12 text-slate-400 text-xs">ÁÑ°Á¥ÄÈåÑ</div> : (
                                    <div className="space-y-4 relative before:absolute before:left-3 before:top-2 before:bottom-2 before:w-px before:bg-slate-600">
                                        {Object.entries(getHistoryByDate()).map(([date, entries]) => (
                                            <div key={date} className="relative pl-8">
                                                <div className="absolute left-1.5 top-0 w-3 h-3 bg-slate-700 rounded-full border-2 border-slate-950 transform -translate-x-1/2 z-10"></div>
                                                <div className="mb-2"><span className="text-[10px] font-bold text-slate-300 bg-slate-600 px-2 py-0.5 rounded">{date}</span></div>
                                                <div className="space-y-2">
                                                    {entries.map(entry => (
                                                        <div key={entry.logId} className="bg-slate-900 border border-slate-800 p-2 rounded-lg flex items-center justify-between shadow-sm">
                                                            <div className="flex items-center gap-2 overflow-hidden min-w-0">
                                                                <span className={`text-xs font-bold truncate ${entry.title.includes('ÂÖåÊèõ:') ? 'text-yellow-400' : 'text-slate-200'}`}>{entry.title}</span>
                                                            </div>
                                                            <div className="flex items-center gap-2 shrink-0">
                                                                {entry.xp !== 0 && <span className={`text-[10px] font-pixel ${entry.xp > 0 ? 'text-indigo-400' : 'text-red-400'}`}>{entry.xp > 0 ? '+' : ''}{entry.xp} XP</span>}
                                                                {entry.money !== 0 && <span className={`text-[10px] font-pixel ${entry.money > 0 ? 'text-yellow-400' : 'text-red-400'}`}>{entry.money > 0 ? '+' : ''}${entry.money} Z</span>}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* Settings & Modals */}
                    <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title="System">
                        <div className="space-y-4 w-full">
                            <div className="bg-white p-3 rounded border border-slate-300 space-y-2">
                                <h4 className="text-[10px] font-bold text-slate-500 uppercase">Data</h4>
                                <div className="flex gap-2">
                                    <Button onClick={handleExportData} className="flex-1 text-xs"><Save size={14} /> Â≠òÊ™î</Button>
                                    <label className="flex-1 ro-btn-base px-3 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 bg-gray-100 text-gray-800 border-gray-300 cursor-pointer hover:bg-gray-200"><Upload size={14} /> ËÆÄÊ™î<input type="file" accept=".json" className="hidden" onChange={handleImportData} /></label>
                                </div>
                            </div>
                             <div className="bg-white p-3 rounded border border-slate-300 space-y-2 flex justify-between items-center">
                                <h4 className="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2">
                                    {user.sound ? <Volume2 size={14} /> : <VolumeX size={14} />} Sound
                                </h4>
                                <button 
                                    onClick={toggleSound}
                                    className={`w-10 h-5 flex items-center rounded-full p-1 transition-all ${user.sound ? 'bg-green-500 justify-end' : 'bg-gray-300 justify-start'}`}
                                >
                                    <div className="w-3 h-3 bg-white rounded-full shadow-sm"></div>
                                </button>
                            </div>
                            <div className="bg-white p-3 rounded border border-slate-300 space-y-2">
                                <h4 className="text-[10px] font-bold text-slate-500 uppercase">Change Job</h4>
                                <div className="flex gap-2"><input type="text" placeholder="ÊâãÂãïËº∏ÂÖ•Êñ∞ËÅ∑Ê•≠..." className="flex-1 px-2 py-1 text-xs" value={newJobTitle} onChange={(e) => setNewJobTitle(e.target.value)} /><Button onClick={confirmJobChange} variant="gold" className="text-xs">ËÆäÊõ¥</Button></div>
                            </div>
                            <div className="bg-white p-3 rounded border border-slate-300 space-y-2">
                                <h4 className="text-[10px] font-bold text-slate-500 uppercase">Reset</h4>
                                <div className="grid grid-cols-1 gap-2">
                                    <Button onClick={handleManualReset} variant="secondary" className="text-xs"><RefreshCw size={14} /> ÈáçÁΩÆÊØèÊó•‰ªªÂãô</Button>
                                    <Button onClick={handleClearHistory} variant="danger" className="text-xs"><Trash2 size={14} /> Ê∏ÖÈô§Á¥ÄÈåÑ</Button>
                                </div>
                            </div>

                            {/* SOS BUTTON */}
                            <div className="pt-4 border-t border-slate-300 mt-2">
                                <h4 className="text-xs font-bold text-red-600 mb-2 uppercase tracking-wider">Danger Zone</h4>
                                <Button onClick={handleHardReset} variant="danger" className="w-full justify-start"><AlertTriangle size={14}/> Âº∑Âà∂Ê∏ÖÈô§ÊâÄÊúâË≥áÊñô (SOS)</Button>
                            </div>
                        </div>
                    </Modal>
                    <Modal isOpen={showCalendar} onClose={() => setShowCalendar(false)} title="Calendar">
                        <div className="grid grid-cols-7 gap-1">{['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'].map(d => <div key={d} className="text-center text-xs font-bold text-slate-500">{d}</div>)}{renderCalendar()}</div>
                    </Modal>
                    <Modal isOpen={!!levelUpData} onClose={() => setLevelUpData(null)} title="LEVEL UP!"><div className="text-center space-y-4 py-4"><div className="mx-auto h-20 w-20 rounded-full bg-yellow-100 flex items-center justify-center animate-bounce text-yellow-600 border-4 border-yellow-200"><img src="https://api.iconify.design/mdi:wings.svg?color=goldenrod" className="w-12 h-12" alt="wings" /></div><div><h2 className="text-3xl font-pixel text-blue-800">LV {levelUpData?.level}</h2><p className="text-sm text-slate-600 mt-1">Congratulations!</p></div><Button onClick={() => setLevelUpData(null)} variant="primary" className="w-full mt-2">Confirm</Button></div></Modal>
                    <Modal isOpen={!!jobChangeData} onClose={() => setJobChangeData(null)} title="JOB CHANGE!"><div className="text-center space-y-4 py-4"><div className="mx-auto h-24 w-24 rounded-full bg-gradient-to-b from-yellow-300 to-yellow-500 flex items-center justify-center animate-job-change border-4 border-white shadow-lg"><Crown size={48} className="text-white drop-shadow-md" /></div><div><h2 className="text-xl font-bold text-blue-900">ÂÆåÊàê: {jobChangeData}</h2><p className="text-sm text-slate-600 mt-2">Ë´ãËº∏ÂÖ•Êñ∞ËÅ∑Ê•≠Ôºö</p><input type="text" placeholder="‰æãÂ¶Ç: Ë≥áÊ∑±Áí∞Â∑•ÊäÄÂ∏´" className="w-full mt-3 px-3 py-2 text-center font-bold text-lg border-2 border-yellow-400 focus:border-yellow-600 rounded" value={newJobTitle} onChange={(e) => setNewJobTitle(e.target.value)} /></div><Button onClick={confirmJobChange} variant="gold" className="w-full mt-2 py-3 text-base">Á¢∫Ë™çËΩâËÅ∑</Button></div></Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LifeRPG />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LifeRPG - v6.9 (Main Quest System)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* --- Styles --- */
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; background-color: #2d3748; background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px); background-size: 20px 20px; font-family: 'Noto Sans TC', sans-serif; color: #1a202c; -webkit-tap-highlight-color: transparent; overflow: hidden; width: 100%; height: 100%; position: fixed; }
        #root { width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; max-width: 100vw; }
        .font-pixel { font-family: 'VT323', monospace; }
        input, select, textarea { font-size: 16px !important; background-color: #f7fafc; border: 1px solid #cbd5e0; color: #2d3748; border-radius: 4px; }
        input:focus, select:focus { outline: 2px solid #63b3ed; border-color: #63b3ed; }
        
        .ro-window { background: linear-gradient(to bottom, #f0f4f8, #e2e8f0); border: 1px solid #a0aec0; border-radius: 6px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.8); position: relative; width: 100%; max-width: 100%; }
        .ro-title-bar { background: linear-gradient(to bottom, #bfdcf5, #8db2e3); border-bottom: 1px solid #7a9bc9; color: #1a365d; text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5); border-radius: 5px 5px 0 0; padding: 4px 8px; font-weight: bold; font-size: 0.9rem; }
        .ro-bar-container { background: #2d3748; border-radius: 9999px; padding: 2px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); border: 1px solid #4a5568; }
        .ro-bar-fill { background: linear-gradient(to bottom, #8ec5fc 0%, #4a90e2 50%, #2b6cb0 51%, #2c5282 100%); border-radius: 9999px; position: relative; overflow: hidden; }
        .ro-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%; background: linear-gradient(to bottom, rgba(255,255,255,0.6), rgba(255,255,255,0.1)); border-radius: 9999px 9999px 0 0; }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }
        .ro-btn-base { border: 1px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: all 0.1s; }
        .ro-btn-base:active { transform: translateY(1px); box-shadow: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        @keyframes job-change-shine { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        .animate-job-change { animation: job-change-shine 1.5s infinite; }
        
        .calendar-day { text-align: center; padding: 6px 0; font-size: 0.8rem; border-radius: 4px; }
        .calendar-day.today { border: 2px solid #63b3ed; font-weight: bold; }
        .calendar-day.selected { background-color: #3182ce; color: white; }
        .calendar-day.has-data { position: relative; }
        .calendar-day.has-data::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background-color: #48bb78; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import * as LucideReact from "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0";
        const { Trophy, Zap, CheckCircle2, Plus, Trash2, Dumbbell, BookOpen, Home, TrendingUp, Lock, Unlock, Star, RefreshCw, X, Briefcase, Heart, Calendar, Clock, Repeat, Download, Filter, HardHat, Info, Settings, Upload, Save, Sword, User, Crown, Sparkles, Gift, Coins, ShoppingBag, Battery, ChevronLeft, ChevronRight, RotateCcw, Volume2, VolumeX, ArrowRight, Star: StarIcon, Coffee, ShoppingCart, Moon, Sun, Edit3, CheckSquare, AlertTriangle, Scroll, GraduationCap } = LucideReact;

        // --- Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type, duration, delay = 0, vol = 0.1) => {
            if (!window.soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + delay + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration);
        };
        const sfx = {
            click: () => playTone(800, 'triangle', 0.05, 0, 0.05),
            confirm: () => { playTone(600, 'square', 0.1, 0, 0.05); playTone(1200, 'square', 0.1, 0.05, 0.05); },
            step: () => { playTone(900, 'sine', 0.05, 0, 0.05); playTone(1500, 'sine', 0.05, 0.05, 0.05); },
            cancel: () => { playTone(300, 'sawtooth', 0.1, 0, 0.05); playTone(150, 'sawtooth', 0.2, 0.1, 0.05); },
            success: () => { playTone(1200, 'sine', 0.1, 0, 0.1); playTone(2400, 'sine', 0.4, 0.05, 0.1); },
            levelup: () => { const now = 0; playTone(523.25, 'square', 0.2, now, 0.1); playTone(659.25, 'square', 0.2, now + 0.1, 0.1); playTone(783.99, 'square', 0.2, now + 0.2, 0.1); playTone(1046.50, 'square', 0.6, now + 0.3, 0.1); },
            questComplete: () => { 
                const now = audioCtx.currentTime;
                [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50].forEach((freq, i) => {
                    playTone(freq, 'square', 0.15, i * 0.15, 0.1);
                });
            }
        };

        // --- Defaults ---
        const DEFAULT_TASKS = [
            { id: 1001, title: "é›ç‹—", category: "fitness", xp: 30, money: 50, repeat: 'daily' }, 
            { id: 1002, title: "å¥èº«/é‹å‹•", category: "fitness", xp: 50, money: 100, stamina: 34, repeat: 'daily' }, 
            { id: 1008, title: "ğŸ’§ å–æ°´", category: "fitness", xp: 5, money: 5, repeat: 'daily', chainIndex: 0, chain: [{ label: "600cc", xp: 5, money: 5 }, { label: "1200cc", xp: 5, money: 5 }, { label: "2000cc (å®Œæˆ)", xp: 10, money: 20 }] }, 
            { id: 3014, title: "ä¸Ÿåƒåœ¾", category: "chores", xp: 10, money: 20, repeat: 'daily' },
            { id: 3021, title: "ç”¨ç‰™ç·š (æ¯æ™š)", category: "fitness", xp: 10, money: 20, repeat: 'daily' },
            { id: 3023, title: "åƒè‡ªå‚™ä½GIé¤ (åˆ)", category: "fitness", xp: 20, money: 40, repeat: 'daily' },
            { id: 2008, title: "è½‰å¸³å·¥ç¨‹æ¬¾", category: "finance", xp: 50, money: 200, repeat: 'weekly' }
        ];

        const DEFAULT_REWARDS = [
            { id: 4001, title: "ç„¡ç½ªæƒ¡æ„Ÿæ‰“é›»å‹• 1å°æ™‚", reqType: 'base', levelReq: 1, cost: 150, currency: 'zeny', category: 'relax', unlocked: false },
            { id: 4002, title: "å–ä¸€æ¯æ‰‹æ–é£² (åŠ æ–™!)", reqType: 'base', levelReq: 3, cost: 80, currency: 'zeny', category: 'food', unlocked: false },
            { id: 4022, title: "Steam/éŠæˆ²èª²é‡‘ ($500å…§)", reqType: 'job', levelReq: 4, cost: 3000, currency: 'zeny', category: 'shopping', unlocked: false },
            { id: 999, title: "è–äººæ¨¡å¼ (é‡‹æ”¾)", reqType: 'base', levelReq: 1, cost: 100, currency: 'stamina', category: 'special', unlocked: true }
        ];

        const categories = {
            fitness: { type: 'base', bg: "bg-red-100 text-red-800", icon: <Dumbbell size={14} />, label: "å¥åº·" },
            chores: { type: 'base', bg: "bg-blue-100 text-blue-800", icon: <Home size={14} />, label: "é›œå‹™" },
            knowledge: { type: 'job', bg: "bg-purple-100 text-purple-800", icon: <BookOpen size={14} />, label: "çŸ¥è­˜" },
            finance: { type: 'job', bg: "bg-emerald-100 text-emerald-800", icon: <TrendingUp size={14} />, label: "ç†è²¡" },
            general: { type: 'base', bg: "bg-gray-100 text-gray-800", icon: <Star size={14} />, label: "ä¸€èˆ¬" },
        };
        const rewardCategories = {
            food: { label: "ğŸ” é£²é£Ÿäº«å—", color: "text-orange-600 border-orange-200 bg-orange-50" },
            relax: { label: "ğŸ’¤ ä¼‘æ¯æ”¾é¬†", color: "text-teal-600 border-teal-200 bg-teal-50" },
            shopping: { label: "ğŸ›ï¸ è³¼ç‰©çŠ’è³", color: "text-pink-600 border-pink-200 bg-pink-50" },
            special: { label: "âœ¨ ç‰¹æ®ŠåŠŸèƒ½", color: "text-purple-600 border-purple-200 bg-purple-50" }
        };

        // --- Components ---
        const Button = ({ onClick, children, variant = "primary", className = "", disabled = false }) => {
            const variants = {
                primary: "bg-blue-100 hover:bg-blue-200 text-blue-900 border-blue-300",
                secondary: "bg-gray-100 hover:bg-gray-200 text-gray-800 border-gray-300",
                danger: "bg-red-50 hover:bg-red-100 text-red-800 border-red-200",
                outline: "bg-transparent border-slate-400 text-slate-600 hover:bg-slate-100",
                gold: "bg-yellow-100 hover:bg-yellow-200 text-yellow-900 border-yellow-400",
                green: "bg-emerald-100 hover:bg-emerald-200 text-emerald-900 border-emerald-300",
                purple: "bg-purple-100 hover:bg-purple-200 text-purple-900 border-purple-300"
            };
            const handleClick = (e) => { if (!disabled) sfx.click(); if (onClick) onClick(e); };
            return <button onClick={handleClick} disabled={disabled} className={`ro-btn-base px-3 py-2 rounded text-sm font-bold flex items-center justify-center gap-2 ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>{children}</button>;
        };

        const ProgressBar = ({ current, max, label, height = "h-4", type = "hp" }) => {
            const percentage = Math.min(100, Math.max(0, (current / max) * 100));
            let barColor = 'bg-gradient-to-b from-blue-400 via-blue-500 to-blue-700'; 
            if (type === 'hp') barColor = 'bg-gradient-to-b from-red-400 via-red-500 to-red-700';
            if (type === 'stamina') barColor = 'bg-gradient-to-b from-emerald-400 via-emerald-500 to-emerald-700';
            return (
                <div className="w-full select-none"><div className="ro-bar-container w-full"><div className={`${height} w-full relative`}><div className="absolute inset-0 w-full h-full bg-slate-800 rounded-full"></div><div className={`h-full ro-bar-fill transition-all duration-500 ease-out ${barColor}`} style={{ width: `${percentage}%` }} /><div className="absolute inset-0 flex items-center justify-center z-10"><span className="text-white font-pixel text-[12px] sm:text-[14px] drop-shadow-[0_1px_1px_rgba(0,0,0,1)] tracking-wide">{Math.floor(current)} / {max}</span></div></div></div></div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm px-4"><div className="ro-window w-full max-w-sm flex flex-col max-h-[85vh] shadow-2xl animate-slide-up"><div className="ro-title-bar flex justify-between items-center shrink-0"><h3 className="flex items-center gap-2 text-sm"><Info size={14}/> {title}</h3><button onClick={() => { sfx.cancel(); onClose(); }} className="text-slate-600 hover:text-red-600 hover:bg-white/50 rounded p-0.5"><X size={18} /></button></div><div className="p-4 overflow-y-auto bg-[#f7fafc]">{children}</div></div></div>;
        };

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const styles = { success: "bg-emerald-100 text-emerald-800 border-emerald-300", error: "bg-red-100 text-red-800 border-red-300", info: "bg-blue-100 text-blue-800 border-blue-300", gold: "bg-yellow-100 text-yellow-800 border-yellow-300 shadow-[0_0_10px_rgba(250,204,21,0.5)]" };
            return <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[70] flex items-center justify-between gap-3 px-4 py-2 rounded-lg border shadow-lg w-[90%] max-w-sm ${styles[type] || styles.info}`}><span className="truncate text-sm font-bold">{message}</span><button onClick={onClose} className="opacity-60 hover:opacity-100"><X size={16} /></button></div>;
        };

        // --- App Logic ---
        function LifeRPG() {
            const [user, setUser] = React.useState(() => {
                const saved = localStorage.getItem('liferpg-user-v2');
                return saved ? JSON.parse(saved) : { name: "Player", jobTitle: "å·¥ç¨‹å¸«", zeny: 0, base: { level: 1, xp: 0, maxXp: 100 }, job: { level: 1, xp: 0, maxXp: 100 }, stamina: { current: 100, max: 100 }, sound: true };
            });
            const [tasks, setTasks] = React.useState(() => { const saved = localStorage.getItem('liferpg-tasks'); return saved ? JSON.parse(saved) : DEFAULT_TASKS; });
            const [dailyCompletions, setDailyCompletions] = React.useState(() => { const saved = localStorage.getItem('liferpg-daily-completions'); return saved ? JSON.parse(saved) : {}; });
            const [rewards, setRewards] = React.useState(() => { const saved = localStorage.getItem('liferpg-rewards-v2'); return saved ? JSON.parse(saved) : DEFAULT_REWARDS; });
            const [history, setHistory] = React.useState(() => { const saved = localStorage.getItem('liferpg-history'); return saved ? JSON.parse(saved) : []; });
            const [appState, setAppState] = React.useState(() => { const saved = localStorage.getItem('liferpg-app-state'); return saved ? JSON.parse(saved) : { lastVisitDate: new Date().toDateString() }; });

            const [activeTab, setActiveTab] = React.useState('tasks');
            const [notification, setNotification] = React.useState(null); 
            const [showSettings, setShowSettings] = React.useState(false);
            const [showCalendar, setShowCalendar] = React.useState(false); 
            const [levelUpData, setLevelUpData] = React.useState(null);
            const [jobChangeData, setJobChangeData] = React.useState(null);
            
            const [newTask, setNewTask] = React.useState({ title: '', category: 'fitness', xp: 20, repeat: 'daily', frequency: 1 });
            const [viewDate, setViewDate] = React.useState(new Date()); 
            const [isEditingName, setIsEditingName] = React.useState(false);
            const [tempName, setTempName] = React.useState(user.name);
            const [newJobTitle, setNewJobTitle] = React.useState("");

            window.soundEnabled = user.sound;
            const getISODate = (d) => { const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
            const viewDateStr = getISODate(viewDate);
            const isToday = viewDateStr === getISODate(new Date());
            const showNotification = (message, type = 'info') => { setNotification({ message, type }); setTimeout(() => setNotification(null), 3000); };
            const calculateMaxXP = (level) => { let xp = 100; for (let i = 1; i < level; i++) xp = Math.floor(xp * 1.2); return xp; };

            React.useEffect(() => { localStorage.setItem('liferpg-user-v2', JSON.stringify(user)); window.soundEnabled = user.sound; }, [user]);
            React.useEffect(() => { localStorage.setItem('liferpg-tasks', JSON.stringify(tasks)); }, [tasks]);
            React.useEffect(() => { localStorage.setItem('liferpg-rewards-v2', JSON.stringify(rewards)); }, [rewards]);
            React.useEffect(() => { localStorage.setItem('liferpg-history', JSON.stringify(history)); }, [history]);
            React.useEffect(() => { localStorage.setItem('liferpg-daily-completions', JSON.stringify(dailyCompletions)); }, [dailyCompletions]);
            React.useEffect(() => { localStorage.setItem('liferpg-app-state', JSON.stringify(appState)); }, [appState]);

            // Status Update
            const updateUserStatus = (xp, catKey, money, sta=0) => {
                const cat = categories[catKey] || categories.general;
                const type = cat.type;
                setUser(prev => {
                    let s = { ...prev[type] }; let newXP = s.xp + xp; let newLvl = s.level; let newMax = s.maxXp; let leveled = false;
                    if (xp > 0) { while (newXP >= newMax) { newXP -= newMax; newLvl++; newMax = Math.floor(newMax * 1.2); leveled = true; } }
                    else { if(newXP < 0 && newLvl > 1) { newLvl--; newMax = calculateMaxXP(newLvl); newXP += newMax; } else if (newXP < 0) newXP = 0; }
                    if (leveled) setTimeout(() => { sfx.levelup(); setLevelUpData({ type, level: newLvl }); }, 100);
                    let newSta = Math.min(prev.stamina.max, Math.max(0, prev.stamina.current + sta));
                    return { ...prev, zeny: Math.max(0, prev.zeny + money), stamina: { ...prev.stamina, current: newSta }, [type]: { level: newLvl, xp: newXP, maxXp: newMax } };
                });
            };

            // Quest / Project Logic
            const handleProjectAction = (task, actionType, payload) => {
                const phaseIdx = task.chainIndex || 0;
                const phase = task.phases[phaseIdx];
                
                if (actionType === 'advance_linear') {
                    updateUserStatus(phase.xp, task.category, phase.money, 0);
                    sfx.step();
                    setHistory(prev => [{ logId: Date.now(), title: `${task.title}: ${phase.label}`, category: task.category, xp: phase.xp, money: phase.money, completedAt: new Date().toISOString() }, ...prev]);
                    const nextIdx = phaseIdx + 1;
                    const isDone = nextIdx >= task.phases.length;
                    setTasks(prev => prev.map(t => t.id === task.id ? { ...t, chainIndex: nextIdx, completed: isDone } : t));
                }
                else if (actionType === 'toggle_parallel') {
                    const itemId = payload;
                    const currentSub = task.subProgress || [];
                    if (currentSub.includes(itemId)) {
                        // Undo item
                        const item = phase.items.find(i => i.id === itemId);
                        updateUserStatus(-item.xp, task.category, -item.money, 0);
                        setTasks(prev => prev.map(t => t.id === task.id ? { ...t, subProgress: t.subProgress.filter(id => id !== itemId) } : t));
                        sfx.cancel();
                    } else {
                        // Complete item
                        const item = phase.items.find(i => i.id === itemId);
                        updateUserStatus(item.xp, task.category, item.money, 0);
                        sfx.step();
                        const newSub = [...currentSub, itemId];
                        setTasks(prev => prev.map(t => t.id === task.id ? { ...t, subProgress: newSub } : t));
                        if (newSub.length === phase.items.length) showNotification("æ‰€æœ‰é …ç›®å®Œæˆï¼å¯é€²å…¥ä¸‹ä¸€éšæ®µ", "success");
                    }
                }
                else if (actionType === 'advance_parallel_phase') {
                    sfx.success();
                    setTasks(prev => prev.map(t => t.id === task.id ? { ...t, chainIndex: phaseIdx + 1, subProgress: [] } : t));
                }
                else if (actionType === 'decision') {
                    const option = payload;
                    if (option.action === 'retry') {
                        sfx.cancel();
                        setTasks(prev => prev.map(t => t.id === task.id ? { ...t, chainIndex: option.targetIndex, subProgress: [] } : t));
                        showNotification("é‡æ–°æŒ‘æˆ°ï¼é€™æ¬¡ä¸€å®šè¡Œï¼", "info");
                    } else if (option.action === 'complete') {
                        sfx.questComplete();
                        setTasks(prev => prev.map(t => t.id === task.id ? { ...t, completed: true } : t));
                        showNotification(`ğŸ‰ æ­å–œï¼ä¸»ç·šä»»å‹™ã€${task.title}ã€‘é”æˆï¼`, "gold");
                        setHistory(prev => [{ logId: Date.now(), title: `ä¸»ç·šå®Œæˆ: ${task.title}`, category: 'knowledge', xp: 2000, money: 5000, isReward: true, completedAt: new Date().toISOString() }, ...prev]);
                        updateUserStatus(2000, task.category, 5000, 0);
                        if (task.title.includes("æŠ€å¸«")) { setTimeout(() => { setNewJobTitle(""); setJobChangeData(task.title); }, 1000); }
                    }
                }
            };

            // Task Actions
            const handleToggleTask = (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (task.repeat === 'project') return; // Handled by buttons
                
                // Regular Logic
                const isCompleted = (dailyCompletions[viewDateStr] || []).includes(task.id);
                if (task.chain) {
                     const idx = Math.min(task.chainIndex||0, task.chain.length-1);
                     const step = task.chain[idx];
                     updateUserStatus(step.xp, task.category, step.money||step.xp*2);
                     sfx.step();
                     const nextIdx = idx + 1;
                     const isDone = nextIdx >= task.chain.length;
                     setTasks(prev => prev.map(pt => pt.id === taskId ? { ...pt, chainIndex: nextIdx, completed: isDone } : pt));
                     setHistory(prev => [{ logId: Date.now(), title: `${task.title} - ${step.label}`, category: task.category, xp: step.xp, money: step.money, completedAt: new Date().toISOString() }, ...prev]);
                     if (isDone) { sfx.success(); setDailyCompletions(prev => ({ ...prev, [viewDateStr]: [...(prev[viewDateStr] || []), taskId] })); showNotification("ä»»å‹™å®Œæˆï¼", "success"); }
                } else {
                    if (!isCompleted) {
                        sfx.success();
                        setDailyCompletions(prev => ({ ...prev, [viewDateStr]: [...(prev[viewDateStr] || []), taskId] }));
                        setTasks(prev => prev.map(pt => pt.id === taskId ? { ...pt, completed: true } : pt));
                        updateUserStatus(task.xp, task.category, task.money || task.xp*2);
                        showNotification("ä»»å‹™å®Œæˆï¼", "success");
                    } else {
                        sfx.cancel();
                        setDailyCompletions(prev => ({ ...prev, [viewDateStr]: prev[viewDateStr].filter(id => id !== taskId) }));
                        setTasks(prev => prev.map(pt => pt.id === taskId ? { ...pt, completed: false } : pt));
                        updateUserStatus(-task.xp, task.category, -(task.money || task.xp*2));
                        showNotification("å·²å¾©åŸ", "info");
                    }
                }
            };

            const handleImportQuestPack = () => {
                if(!window.confirm("åŒ¯å…¥ä¸»ç·šä»»å‹™åŒ…ï¼ˆç’°å·¥æŠ€å¸« & æ©Ÿè»Šé§•ç…§ï¼‰ï¼Ÿ")) return;
                
                const questPE = { 
                    id: 9001, 
                    title: "ä¸»ç·šï¼šç’°å·¥æŠ€å¸«åŸ·ç…§ (PE)", 
                    category: "knowledge", 
                    repeat: 'project', 
                    chainIndex: 0, 
                    subProgress: [],
                    phases: [
                        { label: "1. ç ”ç©¶å ±è€ƒè³‡æ ¼èˆ‡ç°¡ç« ", xp: 50, money: 100, type: 'linear' },
                        { label: "2. å ±åè£œä¿®å­¸åˆ†èª²ç¨‹", xp: 50, money: 200, type: 'linear' },
                        { label: "3. å®Œæˆè£œä¿®å­¸åˆ†èª²ç¨‹", xp: 500, money: 1000, type: 'linear' },
                        { label: "4. å ±åç’°å·¥æŠ€å¸«è€ƒè©¦", xp: 100, money: 300, type: 'linear' },
                        { 
                            label: "5. ç ”è®€ç§‘ç›® (å¯ä¸¦è¡Œ)", 
                            type: 'parallel', 
                            items: [
                                { id: 'p5_1', label: "(1) çµ¦æ°´æ±¡æ°´", xp: 200, money: 400 },
                                { id: 'p5_2', label: "(2) ç©ºæ°£æ±¡æŸ“èˆ‡å™ªéŸ³", xp: 200, money: 400 },
                                { id: 'p5_3', label: "(3) å»¢æ£„ç‰©å·¥ç¨‹", xp: 200, money: 400 },
                                { id: 'p5_4', label: "(4) ç’°åŒ–ç’°å¾®", xp: 200, money: 400 },
                                { id: 'p5_5', label: "(5) ç’°å¢ƒè¦åŠƒèˆ‡ç®¡ç†", xp: 200, money: 400 },
                                { id: 'p5_6', label: "(6) æµåŠ›èˆ‡æ°´æ–‡", xp: 200, money: 400 }
                            ]
                        },
                        { label: "6. æ­·å±†è©¦é¡Œç·´ç¿’", xp: 300, money: 500, type: 'linear' },
                        { label: "7. åƒåŠ è€ƒè©¦ (æ±ºæˆ°æ—¥)", xp: 100, money: 200, type: 'linear' },
                        { 
                            label: "8. æ”¾æ¦œæ™‚åˆ»", 
                            type: 'decision', 
                            options: [
                                { label: "ğŸ˜­ æ²’é€šé (é‡å›å ±å)", action: 'retry', targetIndex: 3 }, 
                                { label: "ğŸ‰ æ­å–œé”æˆ (å®Œæˆ)", action: 'complete' }
                            ]
                        }
                    ]
                };

                const questMoto = { 
                    id: 9002, 
                    title: "ä¸»ç·šï¼šè€ƒå–æ©Ÿè»Šé§•ç…§", 
                    category: "general", 
                    repeat: 'project', 
                    chainIndex: 0, 
                    subProgress: [],
                    phases: [
                        { label: "1. å ±åé«”æª¢èˆ‡è€ƒè©¦", xp: 30, money: 50, type: 'linear' },
                        { label: "2. å®Œæˆé«”æª¢", xp: 30, money: 50, type: 'linear' },
                        { label: "3. ç·´ç¿’ç­†è©¦é¡Œåº«", xp: 50, money: 100, type: 'linear' },
                        { label: "4. åƒåŠ ç­†è©¦", xp: 50, money: 100, type: 'linear' },
                        { label: "5. ç·´ç¿’è·¯è€ƒ (ä¸ƒç§’ç›´ç·š)", xp: 100, money: 200, type: 'linear' },
                        { label: "6. åƒåŠ è·¯è€ƒ", xp: 100, money: 200, type: 'linear' },
                        { 
                            label: "7. é ˜å–é§•ç…§", 
                            type: 'decision', 
                            options: [
                                { label: "âŒ æœªé€šé (é‡è€ƒ)", action: 'retry', targetIndex: 3 }, 
                                { label: "ğŸ›µ æˆåŠŸé ˜ç…§", action: 'complete' }
                            ]
                        }
                    ]
                };
                
                setTasks(prev => {
                    // Filter out old versions if exists
                    const clean = prev.filter(t => t.id !== 9001 && t.id !== 9002);
                    return [questPE, questMoto, ...clean];
                });
                sfx.confirm();
                showNotification("å·²åŒ¯å…¥ä¸»ç·šä»»å‹™", "success");
            }

            const handleReset = () => { if(confirm("ç¢ºå®šè¦é‡ç½®æ¯æ—¥ä»»å‹™å—ï¼Ÿ")) { sfx.confirm(); setTasks(DEFAULT_TASKS); setRewards(DEFAULT_REWARDS); setDailyCompletions({}); } };
            const handleHardReset = () => { if(confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰å­˜æª”ï¼ç¢ºå®šå—ï¼Ÿ")) { localStorage.clear(); window.location.reload(); } };

            // Render Task
            const renderTaskItem = (task) => {
                const cat = categories[task.category] || categories.general;
                const isCompleted = (dailyCompletions[viewDateStr] || []).includes(task.id);
                
                // PROJECT RENDERER
                if (task.repeat === 'project' && task.phases) {
                    const idx = task.chainIndex || 0;
                    const phase = task.phases[Math.min(idx, task.phases.length-1)];
                    const isDone = task.completed;
                    
                    return (
                         <div key={task.id} className={`relative p-4 ro-window mb-4 border-2 shadow-lg ${isDone ? 'border-yellow-500 bg-yellow-50' : 'border-purple-500 bg-purple-50'}`}>
                            <div className="flex items-center justify-between mb-2 border-b border-purple-200 pb-2">
                                <h3 className="font-bold text-purple-900 flex items-center gap-2 text-base"><Sword size={18} className="text-purple-600"/> {task.title}</h3>
                                <span className="text-xs font-bold text-slate-500 bg-white px-2 py-0.5 rounded-full border">{isDone ? "LEGEND" : `Phase ${idx + 1}/${task.phases.length}`}</span>
                            </div>
                            
                            {!isDone && (
                                <div className="mb-3">
                                    <div className="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 bg-white/60 p-2 rounded">
                                        <span className="bg-purple-600 text-white text-xs px-2 py-0.5 rounded shadow-sm">ç•¶å‰ç›®æ¨™</span> 
                                        {phase.label}
                                    </div>
                                    
                                    {phase.type === 'linear' && (
                                        <div className="flex justify-end">
                                            <Button onClick={() => handleProjectAction(task, 'advance_linear')} variant="purple" className="text-xs shadow-md">å®Œæˆæ­¤éšæ®µ (+{phase.xp} XP)</Button>
                                        </div>
                                    )}
                                    
                                    {phase.type === 'parallel' && (
                                        <div className="space-y-1 bg-white/50 p-3 rounded border border-purple-200">
                                            <div className="text-xs text-slate-500 mb-2 font-bold">è«‹é»æ“Šå‹¾é¸å·²å®Œæˆé …ç›®ï¼š</div>
                                            <div className="grid grid-cols-1 gap-1.5">
                                            {phase.items.map(item => {
                                                const isChecked = (task.subProgress || []).includes(item.id);
                                                return (
                                                    <div key={item.id} className={`flex items-center gap-3 cursor-pointer p-2 rounded transition-all border ${isChecked ? 'bg-purple-100 border-purple-300' : 'bg-white hover:bg-slate-100 border-slate-200'}`} onClick={() => handleProjectAction(task, 'toggle_parallel', item.id)}>
                                                        <div className={`w-5 h-5 border rounded flex items-center justify-center transition-colors ${isChecked ? 'bg-purple-500 border-purple-600' : 'bg-white border-slate-300'}`}>
                                                            {isChecked && <CheckSquare size={14} className="text-white" />}
                                                        </div>
                                                        <span className={`text-sm ${isChecked ? 'text-purple-800 font-bold' : 'text-slate-700'}`}>{item.label} <span className="text-[10px] text-slate-400 ml-1">+{item.xp}XP</span></span>
                                                    </div>
                                                )
                                            })}
                                            </div>
                                            <div className="mt-3 flex justify-end">
                                                 <Button 
                                                    disabled={(task.subProgress||[]).length < phase.items.length} 
                                                    onClick={() => handleProjectAction(task, 'advance_parallel_phase')} 
                                                    variant={(task.subProgress||[]).length < phase.items.length ? "secondary" : "purple"}
                                                    className="text-xs w-full"
                                                >
                                                    {(task.subProgress||[]).length < phase.items.length ? `é€²åº¦ ${(task.subProgress||[]).length}/${phase.items.length} (æœªå®Œæˆ)` : "æ‰€æœ‰é …ç›®å®Œæˆ -> ä¸‹ä¸€éšæ®µ"}
                                                </Button>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {phase.type === 'decision' && (
                                        <div className="flex gap-2 mt-2">
                                            {phase.options.map((opt, i) => (
                                                <Button key={i} onClick={() => handleProjectAction(task, 'decision', opt)} variant={opt.action==='complete'?"gold":"danger"} className="flex-1 text-xs justify-center py-3 shadow-md">
                                                    {opt.label}
                                                </Button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {isDone && <div className="text-center py-4 text-yellow-600 font-bold flex flex-col items-center gap-2"><Trophy size={32}/> <span>å‚³èªªé”æˆï¼</span></div>}
                            <div className="mt-1 h-2 w-full bg-slate-300 rounded-full overflow-hidden border border-slate-400">
                                <div className="h-full bg-gradient-to-r from-purple-400 to-purple-600 transition-all duration-500" style={{width: `${(idx / task.phases.length) * 100}%`}}></div>
                            </div>
                         </div>
                    );
                }

                // REGULAR RENDERER
                let displayTitle = task.title;
                let stepInfo = "";
                if (task.chain) {
                     const idx = Math.min(task.chainIndex||0, task.chain.length-1);
                     if (task.completed) { displayTitle += " (å®Œæˆ)"; stepInfo = `(${task.chain.length}/${task.chain.length})`; }
                     else { displayTitle += ` - ${task.chain[idx].label}`; stepInfo = `(${idx+1}/${task.chain.length})`; }
                }
                
                return (
                    <div key={task.id} className={`relative flex items-center justify-between p-3 ro-window ${isCompleted ? 'opacity-50 bg-gray-300 border-gray-400' : 'bg-white'}`}>
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                             <button onClick={() => { sfx.click(); setTasks(prev => prev.map(t => t.id === task.id ? { ...t, isFavorite: !t.isFavorite } : t)); }} className={`shrink-0 ${task.isFavorite ? 'text-yellow-400' : 'text-slate-300 hover:text-yellow-200'}`}><StarIcon size={16} fill={task.isFavorite ? "currentColor" : "none"} /></button>
                             <button onClick={() => handleToggleTask(task.id)} className={`shrink-0 h-6 w-6 rounded shadow-sm flex items-center justify-center border transition-all active:scale-95 ${isCompleted ? 'bg-green-100 border-green-300 text-green-600' : 'bg-white border-slate-300 text-slate-300 hover:border-blue-400'}`}>{isCompleted && <CheckCircle2 size={14} />}</button>
                            <div className="min-w-0 flex-1">
                                <div className="flex items-center gap-2 mb-0.5"><span className={`text-[9px] px-1 rounded border ${cat.bg} flex items-center gap-1`}>{cat.icon} {cat.label}</span><span className="text-[10px] font-pixel text-slate-500">+{task.xp} {cat.type==='base'?'Base':'Job'}</span><span className="text-[10px] font-pixel text-yellow-600 bg-yellow-50 px-1 rounded border border-yellow-200">+${task.money||task.xp*2} Z</span></div>
                                <div className="flex items-center gap-2"><h3 className={`font-bold text-sm truncate ${isCompleted ? 'line-through text-slate-500' : 'text-slate-800'}`}>{displayTitle} <span className="text-[10px] text-slate-500 font-normal">{stepInfo}</span></h3></div>
                            </div>
                        </div>
                        <button onClick={() => { setTasks(tasks.filter(t => t.id !== task.id)); showNotification("å·²åˆªé™¤", "error"); }} className="ml-2 text-slate-400 hover:text-red-500"><Trash2 size={14} /></button>
                    </div>
                );
            };

            const mainQuests = tasks.filter(t => t.repeat === 'project');
            const normalTasks = tasks.filter(t => t.repeat !== 'project');

            // --- Render ---
            return (
                <div className="w-full min-h-full flex flex-col text-sm">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    
                    {/* Header */}
                    <div className="sticky top-0 z-30 w-full pt-safe px-3 pb-2 shrink-0" style={{background: '#2d3748'}}>
                        <div className="ro-window p-3 space-y-2 max-w-lg mx-auto">
                            <div className="flex items-start justify-between border-b border-slate-300 pb-1 mb-1"><h1 className="text-base font-bold text-blue-900 flex items-center gap-2">Player Status</h1><div className="flex items-center gap-2"><div className="bg-white/80 border border-slate-400 rounded px-2 py-0.5 text-xs font-pixel flex items-center gap-1"><span className="text-yellow-600 font-bold">Z</span><span>{user.zeny}</span></div><button onClick={() => setShowSettings(true)} className="text-slate-500"><Settings size={16} /></button></div></div>
                            <div className="flex justify-between items-end px-1"><div>{isEditingName ? (<input autoFocus className="text-sm font-bold text-slate-800 w-32 px-1 py-0.5" value={tempName} onChange={e => setTempName(e.target.value)} onBlur={() => {setIsEditingName(false); setUser({...user, name: tempName}); sfx.confirm();}} />) : (<div className="text-sm font-bold text-slate-800 flex items-center gap-2 cursor-pointer hover:bg-slate-200 rounded px-1 transition-colors" onClick={() => setIsEditingName(true)}>{user.name} <Edit3 size={12} className="text-slate-400"/></div>)}<div className="text-xs font-bold text-blue-700 flex items-center gap-1"><Crown size={12} className="text-yellow-500" /> {user.jobTitle}</div></div></div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-700 w-14 shrink-0">Base Lv.</span><ProgressBar current={user.base.xp} max={user.base.maxXp} height="h-3" /><span className="text-xs font-bold w-8 text-right font-pixel">{user.base.level}</span></div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-700 w-14 shrink-0">Job Lv.</span><ProgressBar current={user.job.xp} max={user.job.maxXp} height="h-3" /><span className="text-xs font-bold w-8 text-right font-pixel">{user.job.level}</span></div>
                            <div className="flex items-center gap-2"><span className="text-xs font-bold text-emerald-700 w-14 shrink-0">STA</span><ProgressBar current={user.stamina?.current || 0} max={user.stamina?.max || 100} height="h-3" type="stamina" /><span className="text-xs font-bold w-8 text-right font-pixel">{Math.floor(user.stamina?.current || 0)}</span></div>
                        </div>
                    </div>

                    <main className="flex-1 w-full max-w-lg mx-auto p-3 pb-32 overflow-x-hidden">
                        <div className="grid grid-cols-2 gap-2 mb-4 w-full">
                            <button onClick={() => {sfx.click(); setActiveTab('tasks')}} className={`ro-btn-base py-2 rounded text-xs font-bold flex items-center justify-center gap-1 ${activeTab === 'tasks' ? 'bg-blue-200 text-blue-900 border-blue-400' : 'bg-white text-slate-600 border-slate-300'}`}><CheckCircle2 size={14} /> ä»»å‹™</button>
                            <button onClick={() => {sfx.click(); setActiveTab('rewards')}} className={`ro-btn-base py-2 rounded text-xs font-bold flex items-center justify-center gap-1 ${activeTab === 'rewards' ? 'bg-amber-200 text-amber-900 border-amber-400' : 'bg-white text-slate-600 border-slate-300'}`}><ShoppingBag size={14} /> å•†åº—</button>
                        </div>

                        {activeTab === 'tasks' && (
                            <div className="space-y-6 pb-12 animate-slide-in">
                                {mainQuests.length > 0 && (
                                    <div className="mb-6">
                                        <h3 className="text-[12px] font-bold text-purple-600 uppercase tracking-widest mb-2 border-b border-purple-200 pb-1 flex items-center gap-1"><Sword size={12}/> ä¸»ç·šä»»å‹™ (Main Quest)</h3>
                                        <div className="space-y-4">{mainQuests.map(t => renderTaskItem(t))}</div>
                                    </div>
                                )}
                                <div>
                                    <h3 className="text-[12px] font-bold text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-600 pb-1">æ¯æ—¥èˆ‡å…¶ä»–ä»»å‹™</h3>
                                    <div className="space-y-2">{normalTasks.map(t => renderTaskItem(t))}</div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'rewards' && (
                            <div className="space-y-4 animate-slide-in">
                                {rewards.map(reward => {
                                     const isUnlocked = (reward.reqType === 'base' ? user.base.level : user.job.level) >= reward.levelReq;
                                     const canAfford = reward.currency === 'zeny' ? user.zeny >= reward.cost : user.stamina.current >= reward.cost;
                                     return (
                                        <div key={reward.id} className={`p-3 ro-window flex items-center justify-between ${isUnlocked ? 'bg-white' : 'bg-gray-200 opacity-80'}`}>
                                            <div><h3 className="font-bold text-sm text-slate-700">{reward.title}</h3><div className="text-[10px] text-slate-500">{reward.currency==='zeny'?'$'+reward.cost+' Z':reward.cost+' STA'}</div></div>
                                            {isUnlocked ? <Button onClick={() => { if(canAfford){ sfx.confirm(); updateUserStatus(0,'general',reward.currency==='zeny'?-reward.cost:0,reward.currency!=='zeny'?-reward.cost:0); showNotification("å·²å…Œæ›","gold"); setHistory(prev=>[{logId:Date.now(),title:`å…Œæ›: ${reward.title}`,category:'general',xp:0,money:0,isReward:true,completedAt:new Date().toISOString()},...prev]); } else { sfx.cancel(); showNotification("é¤˜é¡ä¸è¶³","error"); } }} variant={canAfford?"green":"outline"}>è³¼è²·</Button> : <Lock size={16} className="text-slate-400"/>}
                                        </div>
                                     );
                                })}
                            </div>
                        )}
                    </main>

                    {/* Settings */}
                    <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title="System">
                        <div className="space-y-4">
                            <Button onClick={handleImportQuestPack} variant="purple" className="w-full justify-start"><Scroll size={14}/> åŒ¯å…¥ä¸»ç·šä»»å‹™åŒ… (Main Quest)</Button>
                            <Button onClick={handleReset} variant="secondary" className="w-full"><RefreshCw size={14}/> é‡ç½®æ¯æ—¥ä»»å‹™</Button>
                            <div className="pt-4 border-t border-slate-300 mt-2"><h4 className="text-xs font-bold text-red-600 mb-2 uppercase tracking-wider">Danger Zone</h4><Button onClick={handleHardReset} variant="danger" className="w-full justify-start"><AlertTriangle size={14}/> å¼·åˆ¶æ¸…é™¤æ‰€æœ‰è³‡æ–™</Button></div>
                        </div>
                    </Modal>

                    {/* Level Up & Job Change Modals */}
                    <Modal isOpen={!!levelUpData} onClose={() => setLevelUpData(null)} title="LEVEL UP!"><div className="text-center space-y-4 py-4"><div className="mx-auto h-20 w-20 rounded-full bg-yellow-100 flex items-center justify-center animate-bounce text-yellow-600 border-4 border-yellow-200"><img src="https://api.iconify.design/mdi:wings.svg?color=goldenrod" className="w-12 h-12" alt="wings" /></div><div><h2 className="text-3xl font-pixel text-blue-800">LV {levelUpData?.level}</h2><p className="text-sm text-slate-600 mt-1">Congratulations!</p></div><Button onClick={() => setLevelUpData(null)} variant="primary" className="w-full mt-2">Confirm</Button></div></Modal>
                    <Modal isOpen={!!jobChangeData} onClose={() => setJobChangeData(null)} title="JOB CHANGE!"><div className="text-center space-y-4 py-4"><div className="mx-auto h-24 w-24 rounded-full bg-gradient-to-b from-yellow-300 to-yellow-500 flex items-center justify-center animate-job-change border-4 border-white shadow-lg"><Crown size={48} className="text-white drop-shadow-md" /></div><div><h2 className="text-xl font-bold text-blue-900">å®Œæˆ: {jobChangeData}</h2><p className="text-sm text-slate-600 mt-2">è«‹è¼¸å…¥æ–°è·æ¥­ï¼š</p><input type="text" placeholder="ä¾‹å¦‚: ç’°å·¥æŠ€å¸«" className="w-full mt-3 px-3 py-2 text-center font-bold text-lg border-2 border-yellow-400 focus:border-yellow-600 rounded" value={newJobTitle} onChange={(e) => setNewJobTitle(e.target.value)} /></div><Button onClick={() => { if(newJobTitle.trim()) { sfx.levelup(); setUser(prev => ({ ...prev, jobTitle: newJobTitle })); setJobChangeData(null); showNotification(`è½‰è·æˆåŠŸï¼${newJobTitle}`, "gold"); }}} variant="gold" className="w-full mt-2 py-3 text-base">ç¢ºèªè½‰è·</Button></div></Modal>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LifeRPG />);
    </script>
</body>
</html>
